<%- include("../partials/admin/header") %>

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Add New Product</title>

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css" />

        <style>
            body {
                background-color: #f8f9fa;
            }

            .navbar-brand {
                font-weight: bold;
            }

            .footer {
                background-color: #343a40;
                color: white;
                padding: 20px 0;
                text-align: center;
                margin-top: 40px;
            }

            .error-message {
                color: red;
            }

            .thumbnails-container {
                display: flex;
                overflow-x: auto;
            }

            .thumbnail {
                margin-right: 10px;
            }
        </style>
    </head>

    <body>

        <!-- Header Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid px-4">
                <a class="navbar-brand" href="/admin">Add products</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <!--  -->
            </div>
        </nav>

        <!-- Main Content -->
        <section class="content-main">
            <div class="row">
                <div class="col-9">
                    <div class="content-header">
                        <h2 class="content-title">Add New Product</h2>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <form method="post" action="/admin/product-add" enctype="multipart/form-data"
                                onsubmit="return validateForm()">
                                <div class="mb-4">
                                    <label for="product_name" class="form-label">Product Name</label>
                                    <input type="text" placeholder="Type here" name="productName"
                                        class="form-control border" id="product_name">
                                    <div id="productName-error" class="error-message"></div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">Full description</label>
                                    <textarea placeholder="Type here" id="descriptionid" name="description"
                                        class="form-control border" rows="4"></textarea>
                                    <div id="description-error" class="error-message"></div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Price (₹)</label>
                                        <input name="price" type="number" min="0" step="0.01"
                                            class="form-control border" required />
                                        <div id="price-error" class="error-message"></div>
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Discount Price (₹)</label>
                                        <input name="discountPrice" type="number" min="0" step="0.01"
                                            class="form-control border" />
                                        <div id="discountPrice-error" class="error-message"></div>
                                    </div>
                                </div>



                                <div class="card mb-4">
                                    <div class="card-body">
                                        <div class="row gx-2">
                                            <div class="col-sm-6 mb-3">
                                                <label class="form-label">Category</label>
                                                <select class="form-select border" style="width: 150px;"
                                                    name="category">
                                                    <% for (let i=0; i < cat.length; i++) { %>
                                                        <option value="<%= cat[i].name %>">
                                                            <%= cat[i].name %>
                                                        </option>
                                                        <% } %>

                                                </select>
                                                <div id="category-error" class="error-message"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>





                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h4>Choose Images</h4>
                                    </div>
                                    <div class="card-body">
                                        <input class="form-control mb-3" type="file" name="images" id="imageInput"
                                            multiple accept="image/png, image/jpeg, image/jpg" />
                                        <div id="images-error" class="error-message"></div>
                                        <div id="addedImagesContainer" class="thumbnails-container"></div>
                                    </div>
                                    
                                    <div class="modal fade" id="imageCropModal" tabindex="-1"
                                        aria-labelledby="cropModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="img-container">
                                                        <img id="cropImage" src="" alt="Image to crop" />
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Cancel</button>
                                                    <button type="button" class="btn btn-primary" id="cropButton">Crop &
                                                        Save</button>
                                                    <div id="cropError" class="error-message"
                                                        style="color: red; margin-top: 10px;"></div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <script>
                                    const selectedImagesNew = [];
                                    document.getElementById('imageInput').addEventListener('change', handleMultipleFileSelect);

                                    function handleMultipleFileSelect(event) {
                                        const addedImagesContainer = document.getElementById('addedImagesContainer');
                                        addedImagesContainer.innerHTML = "";
                                        selectedImagesNew.length = 0;

                                        const files = event.target.files;

                                        for (let i = 0; i < files.length; i++) {
                                            const file = files[i];
                                            selectedImagesNew.push(file);

                                            const thumbnail = document.createElement('div');
                                            thumbnail.classList.add('thumbnail');

                                            const img = document.createElement('img');
                                            img.src = URL.createObjectURL(file);
                                            img.alt = "thumbnail";
                                            img.style.width = '80px';
                                            img.style.height = '80px';
                                            img.style.objectFit = 'cover';
                                            img.style.marginRight = '10px';

                                            const removeIcon = document.createElement('span');
                                            removeIcon.classList.add('remove-icon');
                                            removeIcon.style.cursor = 'pointer';
                                            removeIcon.style.marginLeft = '10px';
                                            removeIcon.innerHTML = "&times;";
                                            removeIcon.addEventListener('click', function () {
                                                const index = selectedImagesNew.indexOf(file);
                                                if (index !== -1) {
                                                    selectedImagesNew.splice(index, 1);
                                                    thumbnail.remove();

                                                    // Update the input.files
                                                    const dataTransfer = new DataTransfer();
                                                    selectedImagesNew.forEach(img => dataTransfer.items.add(img));
                                                    document.getElementById('imageInput').files = dataTransfer.files;
                                                }
                                            });

                                            thumbnail.appendChild(img);
                                            thumbnail.appendChild(removeIcon);
                                            addedImagesContainer.appendChild(thumbnail);
                                        }
                                    }



                                </script>



                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="isPublished" id="isPublished"
                                        checked>
                                    <label class="form-check-label" for="isPublished">
                                        Publish Product
                                    </label>
                                </div>


                                <div>
                                    <button class="btn btn-md rounded font-sm hover-up" type="submit"
                                        onclick="validateAndSubmit()">Publish</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer mt-auto">
            <div class="container">
                <p class="mb-0">&copy; <%= new Date().getFullYear() %> Zneakz Admin Panel. All rights reserved.</p>
            </div>
        </footer>

        <!-- JS Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
        <script>
            let cropper;
            let currentFileToCrop;
            const imageInput = document.getElementById('imageInput');
            const cropImage = document.getElementById('cropImage');
            const cropModalElement = document.getElementById('imageCropModal');
            const cropModal = new bootstrap.Modal(cropModalElement);

            // Show thumbnails and set up crop click
            imageInput.addEventListener('change', function (event) {
                const files = event.target.files;
                const container = document.getElementById('addedImagesContainer');
                container.innerHTML = '';

                Array.from(files).forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const thumbnail = document.createElement('img');
                        thumbnail.src = e.target.result;
                        thumbnail.classList.add('thumbnail');
                        thumbnail.style.width = '80px';
                        thumbnail.style.height = '80px';
                        thumbnail.style.objectFit = 'cover';
                        thumbnail.style.cursor = 'pointer';

                        thumbnail.addEventListener('click', () => {
                            currentFileToCrop = file;
                            cropImage.src = e.target.result;

                            // Wait for image to load THEN open modal
                            cropImage.onload = () => {
                                cropModal.show();
                            };
                        });

                        container.appendChild(thumbnail);
                    };
                    reader.readAsDataURL(file);
                });
            });

            // Initialize Cropper only after modal is visible AND image is loaded
            cropModalElement.addEventListener('shown.bs.modal', () => {
                if (cropper) cropper.destroy();

                cropper = new Cropper(cropImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            });

            cropModalElement.addEventListener('hidden.bs.modal', () => {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });

            document.getElementById('cropButton').addEventListener('click', () => {
                if (!cropper) return;

                const canvas = cropper.getCroppedCanvas({ width: 450, height: 450 });
                canvas.toBlob((blob) => {
                    const croppedFile = new File([blob], currentFileToCrop.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now(),
                    });

                    // Replace file in FileList
                    const dt = new DataTransfer();
                    const allFiles = Array.from(imageInput.files);
                    allFiles.forEach(file => {
                        dt.items.add(file === currentFileToCrop ? croppedFile : file);
                    });

                    imageInput.files = dt.files;

                    // Refresh thumbnails
                    const event = new Event('change');
                    imageInput.dispatchEvent(event);

                    cropModal.hide();
                });
            });
        </script>


        <%- include("../partials/admin/footer") %>