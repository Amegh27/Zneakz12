<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("../partials/admin/header") %>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add New Product</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

    <style>
      :root {
        --primary: #000;
        --primary-hover: #1a1a1a;
        --success: #10b981;
        --danger: #ef4444;
        --light: #f8f9fa;
        --border: #e9ecef;
        --text: #212529;
        --text-muted: #6c757d;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
      }

      * {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      html { overflow-y: scroll; }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        min-height: 100vh;
      }

      .navbar {
        background: linear-gradient(135deg, var(--primary) 0%, #2d2d2d 100%);
        box-shadow: var(--shadow-md);
      }

      .navbar-brand {
        font-weight: 800;
        letter-spacing: -0.5px;
      }

      .content-main {
        padding: 2.5rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .content-header {
        margin-bottom: 2.5rem;
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .content-title {
        color: var(--primary);
        font-weight: 800;
        font-size: 2.5rem;
        letter-spacing: -1px;
        margin: 0;
        position: relative;
        display: inline-block;
      }

      .content-title::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 60px;
        height: 4px;
        background: var(--primary);
        border-radius: 2px;
      }

      .card {
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary) 0%, #4a4a4a 100%);
      }

      .card-header {
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
        padding: 1.5rem;
        border-bottom: 2px solid var(--border);
      }

      .card-header h4 {
        margin: 0;
        color: var(--primary);
        font-weight: 800;
        font-size: 1.25rem;
        letter-spacing: -0.5px;
      }

      .card-body {
        padding: 2.5rem;
      }

      .form-label {
        font-weight: 700;
        color: var(--primary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
        display: block;
      }

      .form-control,
      .form-select {
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0.875rem 1.25rem;
        font-size: 0.95rem;
        background: #fafbfc;
        color: var(--text);
        font-weight: 500;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
        outline: none;
      }

      textarea.form-control {
        resize: vertical;
        min-height: 120px;
      }

      .mb-4 {
        margin-bottom: 2rem !important;
      }

      /* Size & Stock Grid */
      .size-stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
      }

      .size-stock-item {
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        padding: 1rem;
        text-align: center;
      }

      .size-stock-item label {
        display: block;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .size-stock-item input[type="number"] {
        text-align: center;
        font-weight: 700;
        font-size: 1.1rem;
      }

      /* Thumbnails */
      .thumbnails-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        padding: 1rem 0;
      }

      .thumb {
        position: relative;
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        aspect-ratio: 1;
      }

      .thumb:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
      }

      .thumb-actions {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.375rem;
      }

      .thumb-btn {
        border: none;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .thumb-btn:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
      }

      .thumb-btn[data-action="crop"] {
        background: var(--primary);
      }

      .thumb-btn[data-action="remove"] {
        background: var(--danger);
      }

      /* File Input */
      input[type="file"] {
        border: 2px dashed var(--border);
        background: #fafbfc;
        padding: 1.5rem;
        border-radius: var(--radius-md);
        cursor: pointer;
        width: 100%;
      }

      input[type="file"]:hover {
        border-color: var(--primary);
        background: white;
      }

      /* Buttons */
      .btn {
        border-radius: var(--radius-sm);
        padding: 0.875rem 2rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Checkbox */
      .form-check {
        padding: 1rem;
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
      }

      .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
      }

      .form-check-label {
        font-weight: 600;
        color: var(--text);
      }

      /* Error Messages */
      .error-message {
        color: var(--danger);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        font-weight: 600;
      }

      /* Modal Styling */
      #cropModal .modal-dialog {
        margin: 0;
      }

      #cropModal .modal-fullscreen {
        width: 100vw;
        height: 100vh;
      }

      #cropModal .modal-content {
        border: none;
        border-radius: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      #cropModal .modal-header {
        background: linear-gradient(135deg, var(--primary) 0%, #2d2d2d 100%);
        color: white;
        border: none;
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow-md);
      }

      #cropModal .modal-header .btn-close {
        filter: brightness(0) invert(1);
      }

      #cropModal .modal-title {
        font-weight: 800;
        font-size: 1.5rem;
        letter-spacing: -0.5px;
      }

      #cropModal .modal-body {
        background: #f8f9fa;
        padding: 10px;
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .crop-container {
        flex: 1;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .crop-container img {
        max-width: 100%;
        max-height: 100%;
        display: block;
      }

      .crop-controls {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 1rem;
        background: #f8f9fa;
        border-top: 2px solid var(--border);
      }

      .crop-controls button {
        min-width: 140px;
        font-weight: 700;
        border-radius: var(--radius-sm);
        padding: 0.875rem 1.5rem;
      }

      /* Footer */
      .footer {
        background: linear-gradient(135deg, var(--primary) 0%, #2d2d2d 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        margin-top: 3rem;
        box-shadow: var(--shadow-lg);
      }

      /* Responsive */
      @media (max-width: 991px) {
        .content-main {
          padding: 1.5rem;
        }

        .content-title {
          font-size: 2rem;
        }

        .card-body {
          padding: 1.5rem;
        }

        .size-stock-grid {
          grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        }
      }

      @media (max-width: 576px) {
        .content-main {
          padding: 1rem;
        }

        .content-title {
          font-size: 1.75rem;
        }

        .card-body {
          padding: 1rem;
        }

        .thumbnails-container {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid px-4">
        <a class="navbar-brand" href="/admin"> Add Products</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>

    <section class="content-main">
      <div class="row">
        <div class="col-12">
          <div class="content-header">
            <h2 class="content-title">Add New Product</h2>
          </div>
        </div>

        <div class="col-lg-8 mx-auto">
          <div class="card mb-4">
            <div class="card-body">
              <form id="productForm" method="post" action="/admin/product-add" enctype="multipart/form-data">
                
                <!-- Product Name -->
                <div class="mb-4">
                  <label for="product_name" class="form-label">Product Name</label>
                  <input type="text" placeholder="Enter product name" name="productName" class="form-control border" id="product_name" />
                  <div id="productName-error" class="error-message"></div>
                </div>

                <!-- Description -->
                <div class="mb-4">
                  <label class="form-label">Full Description</label>
                  <textarea placeholder="Enter detailed product description" id="descriptionid" name="description" class="form-control border" rows="4"></textarea>
                  <div id="description-error" class="error-message"></div>
                </div>

                <!-- Pricing -->
                <div class="row">
                  <div class="col-md-6 mb-4">
                    <label class="form-label">Regular Price (₹)</label>
                    <input id="regularPrice" name="price" type="number" min="0" step="0.01" class="form-control border" placeholder="0.00" />
                  </div>

                  <div class="col-md-6 mb-4">
                    <label class="form-label">Discount Price (₹)</label>
                    <input id="salesPrice" name="discountPrice" type="number" min="0" step="0.01" class="form-control border" placeholder="0.00" />
                    <div id="salesPrice-error" class="error-message"></div>
                  </div>
                </div>

                <!-- Size & Stock -->
                <div class="card mb-4">
                  <div class="card-header"><h4> Size & Stock Availability</h4></div>
                  <div class="card-body">
                    <div class="size-stock-grid">
                      <% const availableSizes = ["6","7","8","9","10"]; %>
                      <% availableSizes.forEach((size, index) => { %>
                        <div class="size-stock-item">
                          <label class="form-label">Size <%= size %></label>
                          <input type="number" class="form-control border" name="sizes[<%= index %>][stock]" min="0" value="0" placeholder="0" />
                          <input type="hidden" name="sizes[<%= index %>][size]" value="<%= size %>" />
                        </div>
                      <% }); %>
                    </div>
                  </div>
                </div>

                <!-- Category -->
                <div class="card mb-4">
                  <div class="card-body">
                    <label class="form-label">Category</label>
                    <select class="form-select border" name="category">
                      <% for (let i=0; i < cat.length; i++) { %>
                       <option value="<%= cat[i]._id %>"><%= cat[i].name %></option>
                      <% } %>
                    </select>
                    <div id="category-error" class="error-message"></div>
                  </div>
                </div>

                <!-- Images -->
                <div class="card mb-4">
                  <div class="card-header"><h4>Product Images</h4></div>
                  <div class="card-body">
                    <input class="form-control mb-3" type="file" name="images" id="imageInput" multiple accept="image/png, image/jpeg, image/jpg" />
                    <div id="images-error" class="error-message"></div>
                    <div id="addedImagesContainer" class="thumbnails-container"></div>
                  </div>
                </div>

                <div class="form-check mb-4">
                  <input class="form-check-input" type="checkbox" name="isPublished" id="isPublished" checked />
                  <label class="form-check-label" for="isPublished">✓ Publish Product Immediately</label>
                </div>

                <!-- Submit -->
                <div class="d-grid">
                  <button class="btn btn-primary" type="submit">
                    ✓ Publish Product
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">✂️ Crop Image</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="crop-container">
              <img id="cropImage" src="/placeholder.svg" alt="crop" />
            </div>
            <div class="crop-controls">
              <button type="button" class="btn btn-secondary" id="resetCropBtn">↺ Reset</button>
              <button type="button" class="btn btn-primary" id="applyCropBtn">✓ Apply Crop</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer mt-auto">
      <div class="container">
        <p class="mb-0">&copy; <%= new Date().getFullYear() %> Zneakz Admin Panel. All rights reserved.</p>
      </div>
    </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('productForm');
  let imageInput = document.getElementById('imageInput');
  const addedImagesContainer = document.getElementById('addedImagesContainer');

  const productNameInput = document.getElementById('product_name');
  const descriptionInput = document.getElementById('descriptionid');
  const categorySelect = document.querySelector("select[name='category']");
  const regularPriceInput = document.getElementById('regularPrice');
  const salesPriceInput = document.getElementById('salesPrice');

  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
  const selectedFiles = [];
  let isUpdatingFiles = false;

  let cropper = null;
  let currentCropIndex = -1;
  const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
  const cropImage = document.getElementById('cropImage');
  const resetCropBtn = document.getElementById('resetCropBtn');
  const applyCropBtn = document.getElementById('applyCropBtn');

  const freshInput = imageInput.cloneNode(true);
  imageInput.parentNode.replaceChild(freshInput, imageInput);
  imageInput = freshInput;

  function renderThumbnails() {
    addedImagesContainer.innerHTML = '';
    selectedFiles.forEach((file, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'thumb';
      wrapper.dataset.index = String(idx);

      const img = document.createElement('img');
      img.alt = 'thumbnail';
      img.src = URL.createObjectURL(file);

      const actions = document.createElement('div');
      actions.className = 'thumb-actions';

      const cropBtn = document.createElement('button');
      cropBtn.type = 'button';
      cropBtn.className = 'thumb-btn';
      cropBtn.textContent = 'Crop';
      cropBtn.dataset.action = 'crop';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'thumb-btn';
      removeBtn.textContent = '×';
      removeBtn.dataset.action = 'remove';

      actions.appendChild(cropBtn);
      actions.appendChild(removeBtn);
      wrapper.appendChild(img);
      wrapper.appendChild(actions);
      addedImagesContainer.appendChild(wrapper);
    });
  }

  function syncInputFilesFromState() {
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    isUpdatingFiles = true;
    imageInput.files = dt.files;
    setTimeout(() => { isUpdatingFiles = false; }, 0);
  }

  function initCropper(file, index) {
    currentCropIndex = index;
    const reader = new FileReader();
    reader.onload = (e) => {
      cropImage.src = e.target.result;
      
      if (cropper) {
        cropper.destroy();
      }
      
      cropper = new Cropper(cropImage, {
        aspectRatio: NaN,
        viewMode: 1,
        autoCropArea: 1,
        responsive: true,
        restore: true,
        guides: true,
        center: true,
        highlight: true,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: true,
      });
      
      cropModal.show();
    };
    reader.readAsDataURL(file);
  }

  resetCropBtn.addEventListener('click', () => {
    if (cropper) {
      cropper.reset();
    }
  });

  applyCropBtn.addEventListener('click', () => {
    if (cropper && currentCropIndex >= 0) {
      const canvas = cropper.getCroppedCanvas();
      canvas.toBlob((blob) => {
        const croppedFile = new File([blob], selectedFiles[currentCropIndex].name, {
          type: 'image/png',
          lastModified: Date.now(),
        });
        selectedFiles[currentCropIndex] = croppedFile;
        renderThumbnails();
        syncInputFilesFromState();
        cropModal.hide();
      });
    }
  });

  imageInput.addEventListener('change', (e) => {
    if (isUpdatingFiles) return;
    const files = Array.from(e.target.files);
    const valid = [];

    for (const file of files) {
      if (!allowedTypes.includes(file.type)) {
        Swal.fire({ icon: 'error', title: 'Invalid file type', text: 'Only JPG, JPEG, or PNG images are allowed.', confirmButtonColor: '#ef4444' });
      } else {
        valid.push(file);
      }
    }

    if (valid.length === 0) {
      selectedFiles.splice(0);
      renderThumbnails();
      syncInputFilesFromState();
      return;
    }

    if (valid.length > 4) {
      Swal.fire({ icon: 'error', title: 'Too Many Images', text: 'You can upload a maximum of 4 images.', confirmButtonColor: '#ef4444' });
      valid.length = 4;
    }

    selectedFiles.splice(0, selectedFiles.length, ...valid);
    renderThumbnails();
    syncInputFilesFromState();
  });

  addedImagesContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('.thumb-btn');
    if (!btn) return;

    const wrapper = e.target.closest('.thumb');
    if (!wrapper) return;
    const idx = Number(wrapper.dataset.index);
    if (Number.isNaN(idx)) return;

    const action = btn.dataset.action;
    if (action === 'crop') {
      initCropper(selectedFiles[idx], idx);
      return;
    }
    if (action === 'remove') {
      selectedFiles.splice(idx, 1);
      renderThumbnails();
      syncInputFilesFromState();
      return;
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const productName = productNameInput.value.trim();
    const description = descriptionInput.value.trim();
    const category = categorySelect.value.trim();
    const regularPrice = parseFloat(regularPriceInput.value);
    const salesPrice = parseFloat(salesPriceInput.value);
    const files = Array.from(imageInput.files);

    const sizeInputs = form.querySelectorAll("input[name^='sizes'][name$='[stock]']");
    let totalStock = 0;
    sizeInputs.forEach(input => {
      const val = parseInt(input.value, 10) || 0;
      totalStock += val;
    });

    if (!productName || !description || !category || Number.isNaN(regularPrice)) {
      return Swal.fire({
        icon: 'error',
        title: 'Missing Fields',
        text: 'Please fill in all required fields.',
        confirmButtonColor: '#ef4444'
      });
    }

    if (totalStock <= 0) {
      return Swal.fire({
        icon: 'error',
        title: 'Invalid Stock',
        text: 'Please add stock for at least one size.',
        confirmButtonColor: '#ef4444'
      });
    }

    if (!Number.isNaN(regularPrice) && !Number.isNaN(salesPrice) && salesPrice > regularPrice) {
      return Swal.fire({ icon: 'error', title: 'Invalid Price', text: 'Discount price cannot exceed regular price.', confirmButtonColor: '#ef4444' });
    }

    if (files.length === 0) {
      return Swal.fire({ icon: 'error', title: 'No Images Uploaded', text: 'Please upload at least one product image.', confirmButtonColor: '#ef4444' });
    }

    if (files.length > 4) {
      return Swal.fire({ icon: 'error', title: 'Too Many Images', text: 'You can upload a maximum of 4 images.', confirmButtonColor: '#ef4444' });
    }

    const formData = new FormData(form);

    try {
      const res = await fetch('/admin/product-add', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (res.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: data.message,
          confirmButtonColor: '#10b981',
          showConfirmButton: false,
          timer: 1500
        }).then(() => {
          window.location.href = '/admin/products';
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Duplicate Product!',
          text: data.error || 'Product already exists. Try a different name.',
          confirmButtonColor: '#ef4444'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Server Error',
        text: 'Something went wrong while adding the product.',
        confirmButtonColor: '#ef4444'
      });
    }
  });
});
</script>

    <%- include("../partials/admin/footer") %>
  </body>
</html>