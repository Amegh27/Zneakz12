<%- include("../partials/admin/header") %>

<head>
  <meta charset="utf-8">
  <title>Zneakz Dashboard - Coupons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/admin-assets/css/main.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
    }

    .main-wrap {
      margin-left: 130px;
      padding: 20px 40px;
      background-color: #fff;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    .content-main {
      margin: 0 auto;
      padding-left: 10px;
      max-width: 96%;
    }

    h3 {
      font-weight: 700;
      font-size: 1.8rem;
    }

    .card {
      border-radius: 10px;
      border: none;
    }

    .table th, .table td {
      text-align: center;
      vertical-align: middle;
    }

    .table thead {
      background: #000;
      color: #fff;
    }

    .btn-dark {
      background-color: #000;
      border-color: #000;
    }

    .btn-dark:hover {
      background-color: #333;
    }

    @media (max-width: 992px) {
      .main-wrap {
        margin-left: 220px;
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <main class="main-wrap">
    <section class="content-main">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üéüÔ∏è Coupon Management</h3>
        <button class="btn btn-dark" data-bs-toggle="collapse" data-bs-target="#addCouponForm">
          + Add Coupon
        </button>
      </div>

      <!-- Add Coupon Form -->
      <div class="collapse mb-4" id="addCouponForm">
        <div class="card shadow-sm">
          <div class="card-body">
            <form action="/admin/coupons/create" method="POST" class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input name="name" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Code</label>
                <input name="code" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Discount Type</label>
                <select name="discountType" class="form-select">
                  <option value="percentage">Percentage</option>
                  <option value="flat">Flat</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Discount Value</label>
                <input type="number" name="discountValue" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Min Purchase</label>
                <input type="number" name="minPurchase" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Max Discount</label>
                <input type="number" name="maxDiscount" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Expiry Date</label>
                <input type="date" name="expiryDate" class="form-control" required />
              </div>
              <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-dark px-4">Create Coupon</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Coupon Table -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Min Purchase</th>
                <th>Max Discount</th>
                <th>Expiry</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (coupons.length === 0) { %>
                <tr><td colspan="9" class="text-center text-muted py-4">No coupons created yet.</td></tr>
              <% } else { %>
                <% coupons.forEach(c => { %>
                  <tr>
                    <td><%= c.name %></td>
                    <td><%= c.code %></td>
                    <td><%= c.discountType %></td>
                    <td>
                      <% if (c.discountType === 'percentage') { %>
                        <%= c.discountValue %>% 
                      <% } else { %>
                        ‚Çπ<%= c.discountValue %>
                      <% } %>
                    </td>
                    <td>‚Çπ<%= c.minPurchase %></td>
                    <td>‚Çπ<%= c.maxDiscount %></td>
                    <td><%= new Date(c.expiryDate).toLocaleDateString() %></td>
                    <td>
                      <% if (c.isActive) { %>
                        <span class="badge bg-success">Active</span>
                      <% } else { %>
                        <span class="badge bg-secondary">Inactive</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="d-flex justify-content-center gap-2">
                        <a href="/admin/coupons/toggle/<%= c._id %>" class="btn btn-sm btn-outline-dark">
                          <%= c.isActive ? 'Deactivate' : 'Activate' %>
                        </a>
                        <a href="/admin/coupons/delete/<%= c._id %>"
                           class="btn btn-sm btn-outline-danger"
                           onclick="return confirmDelete(event, '<%= c.code %>')">
                          Delete
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    function confirmDelete(e, code) {
      e.preventDefault();
      const url = e.currentTarget.href;
      Swal.fire({
        title: 'Delete Coupon?',
        text: `Are you sure you want to delete "${code}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#000',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, Delete',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
