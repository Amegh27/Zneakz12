<%- include('../partials/admin/header') %>

<style>
  :root {
    --gradient-black: linear-gradient(135deg, #000000 0%, #111111 100%);
    --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success: #10b981;
    --danger: #ef4444;
    --text-dark: #1a1a1a;
    --light-bg: #f8f9fa;
    --border-color: #e5e7eb;
  }

  body {
    background: #f5f6f7;
    font-family: "Inter", "Segoe UI", sans-serif;
    color: var(--text-dark);
  }

  h2 {
    font-weight: 700;
    font-size: 2rem;
    background: var(--gradient-blue);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 2rem;
  }

  .return-card {
    border: none;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    background: #fff;
  }

  .return-header {
    background: var(--gradient-black);
    color: #fff;
    padding: 1.25rem 2rem;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    align-items: center;
  }

  .return-header .fw-bold {
    font-size: 1.1rem;
  }

  .return-table-wrapper {
    width: 100%;
    background: #fff;
  }

  table.return-table {
    width: 100%;
    border-collapse: collapse;
  }

  .return-table th {
    background: var(--light-bg);
    padding: 1rem 1.5rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border-color);
  }

  .return-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
  }

  .return-table tr:hover {
    background: #f9fafb;
  }

  .badge {
    font-size: 0.85rem;
    border-radius: 6px;
    padding: 0.35rem 0.6rem;
    font-weight: 600;
  }

  .bg-success {
    background: #10b981 !important;
    color: #fff !important;
  }

  .bg-danger {
    background: #ef4444 !important;
    color: #fff !important;
  }

  .bg-warning {
    background: #facc15 !important;
    color: #1a1a1a !important;
  }

  .btn {
    border-radius: 8px;
    font-weight: 600;
    padding: 0.45rem 0.8rem;
    border: none;
    cursor: pointer;
    transition: all 0.25s ease;
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .return-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .return-table th,
    .return-table td {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
    }
  }
</style>

<div class="container-fluid px-0 mt-4">
  <div class="px-4">
    <h2>Return Requests</h2>
  </div>

  <% if (!returns || returns.length === 0) { %>
    <div class="alert alert-info mx-4 shadow-sm" 
         style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #667eea;">
      <strong>No return requests found.</strong> All returns have been processed.
    </div>
  <% } else { %>
    <% returns.forEach(order => { %>
      <div class="return-card mb-5">
        <!-- FULL-WIDTH HEADER -->
        <div class="return-header">
          <div>
            <div class="fw-bold">Order ID: <%= order.orderID %></div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
              ðŸ‘¤ <%= order.user?.name %> 
              <span style="opacity: 0.8;">(<%= order.user?.email %>)</span>
            </div>
          </div>
          <small style="opacity: 0.9;">ðŸ“… <%= order.createdAt.toLocaleString() %></small>
        </div>

        <!-- FULL-WIDTH TABLE -->
        <div class="return-table-wrapper">
          <table class="return-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Size</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Return Reason</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% order.items.forEach(item => { %>
                <% if (item.returnStatus && item.returnStatus !== 'None') { %>
                  <tr>
                    <td>
                      <div class="d-flex align-items-center gap-3">
                        <% if (item.product?.productImage?.length > 0) { %>
                          <img src="/uploads/products/<%= item.product.productImage[0] %>" 
                               alt="Product" width="50" height="50" class="rounded" style="object-fit: cover;">
                        <% } %>
                        <span><%= item.product?.productName %></span>
                      </div>
                    </td>
                    <td><%= item.size || 'â€”' %></td>
                    <td><span class="badge bg-light text-dark"><%= item.quantity %></span></td>
                    <td style="color:#667eea; font-weight:600;">â‚¹<%= item.price.toFixed(2) %></td>
                    <td><%= item.returnReason || 'No reason provided' %></td>
                    <td>
                      <span class="badge 
                        <%= item.returnStatus === 'Approved' ? 'bg-success' 
                        : item.returnStatus === 'Rejected' ? 'bg-danger' 
                        : 'bg-warning' %>">
                        <%= item.returnStatus %>
                      </span>
                    </td>
                    <td>
                      <% if (item.returnStatus === 'Requested') { %>
                        <div class="d-flex gap-2">
                          <button class="btn btn-sm btn-success approve-return" 
                                  data-orderid="<%= order._id %>" 
                                  data-itemid="<%= item._id %>">âœ“ Approve</button>
                          <button class="btn btn-sm btn-danger reject-return" 
                                  data-orderid="<%= order._id %>" 
                                  data-itemid="<%= item._id %>">âœ• Reject</button>
                        </div>
                      <% } else { %>
                        <small class="text-muted">â€”</small>
                      <% } %>
                    </td>
                  </tr>
                <% } %>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    <% }) %>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll('.approve-return').forEach(btn => {
  btn.addEventListener('click', async () => {
    const { orderid, itemid } = btn.dataset;
    const confirm = await Swal.fire({
      title: 'Approve Return?',
      text: 'The customer will be notified.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, approve'
    });
    if (!confirm.isConfirmed) return;
    const res = await fetch(`/admin/returns/${orderid}/${itemid}/approve`, { method: 'POST' });
    const data = await res.json();
    if (data.success) Swal.fire('Approved', data.message, 'success').then(() => location.reload());
    else Swal.fire('Error', data.message, 'error');
  });
});

document.querySelectorAll('.reject-return').forEach(btn => {
  btn.addEventListener('click', async () => {
    const { orderid, itemid } = btn.dataset;
    const confirm = await Swal.fire({
      title: 'Reject Return?',
      text: 'The customer will be notified.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, reject'
    });
    if (!confirm.isConfirmed) return;
    const res = await fetch(`/admin/returns/${orderid}/${itemid}/reject`, { method: 'POST' });
    const data = await res.json();
    if (data.success) Swal.fire('Rejected', data.message, 'info').then(() => location.reload());
    else Swal.fire('Error', data.message, 'error');
  });
});
</script>

<%- include('../partials/admin/footer') %>
