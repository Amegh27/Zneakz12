<%- include("../partials/admin/header") %>

<div class="dashboard-wrapper">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div>
      <h1 class="dashboard-title">üìàDashboard</h1>
      <p class="dashboard-subtitle">Real-time analytics and performance metrics</p>
    </div>
    <select id="filterSelect" class="filter-select">
      <option value="yearly">Yearly</option>
      <option value="monthly" selected>Monthly</option>
      <option value="weekly">Weekly</option>
      <option value="daily">Daily</option>
    </select>
  </div>

  
  <div class="charts-container">
    <div class="chart-card">
      <div class="chart-header">
        <h2 class="chart-title">Sales Performance</h2>
        <span class="filter-badge" id="currentFilter">Monthly</span>
      </div>
      <div class="chart-wrapper">
        <canvas id="salesChart" height="80"></canvas>
      </div>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-icon">üìà</div>
      <div class="metric-content">
        <p class="metric-label">Total Sales</p>
        <p class="metric-value">‚Çπ0</p>
        <p class="metric-change positive">‚Üë Loading...</p>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon">üõçÔ∏è</div>
      <div class="metric-content">
        <p class="metric-label">Top Product</p>
        <p class="metric-value">--</p>
        <p class="metric-change">Top performer</p>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon">üì¶</div>
      <div class="metric-content">
        <p class="metric-label">Total Orders</p>
        <p class="metric-value">0</p>
        <p class="metric-change">This period</p>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-icon">üèÜ</div>
      <div class="metric-content">
        <p class="metric-label">Best Category</p>
        <p class="metric-value">--</p>
        <p class="metric-change">Top performer</p>
      </div>
    </div>
  </div>


  <div class="lists-container">
    <div class="list-card">
      <div class="list-header">
        <h3 class="list-title">Top Products</h3>
        <span class="list-count" id="productCount">0</span>
      </div>
      <ul id="topProducts" class="custom-list"></ul>
    </div>

    <div class="list-card">
      <div class="list-header">
        <h3 class="list-title">Top Categories</h3>
        <span class="list-count" id="categoryCount">0</span>
      </div>
      <ul id="topCategories" class="custom-list"></ul>
    </div>
  </div>
</div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --primary-bg: #0a0e12;
    --secondary-bg: #121820;
    --tertiary-bg: #1a2332;
    --accent-gold: #d4af37;
    --accent-light-gold: #e8c547;
    --text-primary: #f5f5f5;
    --text-secondary: #b0b8c1;
    --border-color: #1f2b3a;
    --chart-gradient-1: #d4af37;
    --chart-gradient-2: #a89550;
    --success-color: #7fbf7f;
    --radius: 8px;
  }

  body {
    background-color: var(--primary-bg);
    color: var(--text-primary);
    font-family: 'Georgia', 'Garamond', serif;
    line-height: 1.7;
    letter-spacing: 0.3px;
  }

  .dashboard-wrapper {
    padding: 3rem 2.5rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3.5rem;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .dashboard-title {
    font-size: 2.8rem;
    font-weight: 300;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
    color: #0a0e12;
  }

  .dashboard-subtitle {
    font-size: 0.9rem;
    color: var(--text-secondary);
    letter-spacing: 0.05em;
    font-weight: 300;
  }

  .filter-select {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 0.85rem 1.2rem;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.3s ease;
    outline: none;
    font-family: 'Georgia', serif;
    letter-spacing: 0.02em;
  }

  .filter-select:hover {
    border-color: var(--accent-gold);
    background-color: var(--tertiary-bg);
  }

  .filter-select:focus {
    border-color: var(--accent-gold);
    box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 3.5rem;
  }

  .metric-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 2rem;
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    position: relative;
    overflow: hidden;
  }

  .metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .metric-card:hover {
    border-color: var(--accent-gold);
    background-color: var(--tertiary-bg);
    transform: translateY(-3px);
  }

  .metric-card:hover::before {
    opacity: 1;
  }

  .metric-icon {
    font-size: 2.2rem;
    min-width: 60px;
    text-align: center;
    opacity: 0.8;
  }

  .metric-content {
    flex: 1;
  }

  .metric-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.8rem;
    font-weight: 400;
  }

  /* Metric values displayed in elegant gold */
  .metric-value {
    font-size: 2rem;
    font-weight: 300;
    margin-bottom: 0.6rem;
    color: var(--accent-gold);
    letter-spacing: 0.02em;
  }

  .metric-change {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 300;
  }

  .metric-change.positive {
    color: var(--success-color);
  }

  /* Charts Section */
  .charts-container {
    margin-bottom: 3.5rem;
  }

  /* Chart card with luxury styling and gradient top border */
  .chart-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 2.5rem;
    transition: all 0.4s ease;
    position: relative;
  }

  .chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .chart-card:hover {
    border-color: var(--accent-gold);
  }

  .chart-card:hover::before {
    opacity: 1;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .chart-title {
    font-size: 1.3rem;
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  .filter-badge {
    background-color: var(--tertiary-bg);
    color: var(--accent-gold);
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 400;
    border: 1px solid var(--accent-gold);
    letter-spacing: 0.05em;
  }

  .chart-wrapper {
    position: relative;
    height: 350px;
    margin-bottom: 1rem;
  }

  /* Lists Section */
  .lists-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 2rem;
  }

  /* List cards with luxury styling and gradient top border */
  .list-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 2rem;
    transition: all 0.4s ease;
    position: relative;
  }

  .list-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .list-card:hover {
    border-color: var(--accent-gold);
  }

  .list-card:hover::before {
    opacity: 1;
  }

  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .list-title {
    font-size: 1.1rem;
    font-weight: 400;
    letter-spacing: 0.02em;
  }

  /* List count badge with gold styling */
  .list-count {
    background-color: var(--tertiary-bg);
    color: var(--accent-gold);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 400;
    border: 1px solid var(--accent-gold);
    letter-spacing: 0.05em;
  }

  .custom-list {
    list-style: none;
  }

  .custom-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 0;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
    font-weight: 300;
  }

  .custom-list li:last-child {
    border-bottom: none;
  }

  .custom-list li:hover {
    background-color: rgba(212, 175, 55, 0.05);
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }

  /* Strong text in list items displayed in gold */
  .custom-list li strong {
    color: var(--accent-gold);
    font-weight: 400;
    margin-right: 0.75rem;
    letter-spacing: 0.02em;
  }

  .custom-list li span:last-child {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 300;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-wrapper {
      padding: 1.5rem;
    }

    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 2.5rem;
    }

    .metrics-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .chart-wrapper {
      height: 250px;
    }

    .lists-container {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .dashboard-title {
      font-size: 2rem;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

async function loadSalesChart(filter = 'monthly') {
  const res = await fetch(`/admin/sales-data?filter=${filter}`);
  const { data } = await res.json();

  let labels = data.map(i => i._id);

  if (filter === 'daily') {
  labels = labels.map(timeStr => {
    const parts = timeStr.split(" ")[1]; 
    const [hour, minute] = parts.split(":");
    const h = parseInt(hour);
    const ampm = h >= 12 ? "PM" : "AM";
    const displayHour = h % 12 === 0 ? 12 : h % 12;
    return `${displayHour}:${minute} ${ampm}`;
  });
}
 else if (filter === 'weekly') {
    const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    labels = labels.map(d => days[d - 1] || d);
  }

  const values = data.map(i => i.totalSales);
  const totalOrders = data.reduce((a, b) => a + b.totalOrders, 0);
  const totalSales = values.reduce((a, b) => a + b, 0);

  document.querySelector('.metric-card:nth-child(1) .metric-value').textContent =
    '‚Çπ' + totalSales.toLocaleString('en-IN');
  document.querySelector('.metric-card:nth-child(3) .metric-value').textContent =
    totalOrders.toLocaleString('en-IN');

  document.getElementById('currentFilter').textContent =
    filter.charAt(0).toUpperCase() + filter.slice(1);

  if (chart) chart.destroy();

  const ctx = document.getElementById('salesChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(212, 175, 55, 0.1)');
  gradient.addColorStop(1, 'rgba(168, 149, 80, 0.02)');

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: `Total Sales (‚Çπ) - ${filter.toUpperCase()}`,
        data: values,
        fill: true,
        borderColor: '#d4af37',
        backgroundColor: gradient,
        tension: 0.4,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        y: {
          ticks: {
            color: '#b0b8c1',
            callback: v => '‚Çπ' + (v / 1000).toFixed(0) + 'K',
          },
          grid: { color: '#1f2b3a' },
        },
        x: {
          ticks: { color: '#b0b8c1' },
          grid: { display: false },
        }
      }
    }
  });
}

async function loadTop(type, url, listId, countId) {
  const res = await fetch(url);
  const data = await res.json();
  const key = type === 'products' ? 'products' : 'categories';
  const items = data[key] || [];

  const list = document.getElementById(listId);
  const countEl = document.getElementById(countId);
  list.innerHTML = '';
  countEl.textContent = items.length;

  if (items.length === 0) {
    list.innerHTML = '<li><span style="color:#b0b8c1;">No data available</span></li>';
    return;
  }

  items.forEach((item, index) => {
    const li = document.createElement('li');
    li.innerHTML = `
      <span><strong>#${index + 1}</strong> ${item.name || 'Unknown'}</span>
      <span>${item.totalQuantity} units</span>`;
    list.appendChild(li);
  });

  if (type === 'products' && items[0]) {
    document.querySelector('.metric-card:nth-child(2) .metric-value').textContent =
      items[0].name || 'N/A';
  }
  if (type === 'categories' && items[0]) {
    document.querySelector('.metric-card:nth-child(4) .metric-value').textContent =
      items[0].name || 'N/A';
  }
}

document.getElementById('filterSelect').addEventListener('change', e => {
  loadSalesChart(e.target.value);
});

loadSalesChart();
loadTop('products', '/admin/best-products', 'topProducts', 'productCount');
loadTop('categories', '/admin/best-categories', 'topCategories', 'categoryCount');
</script>

<%- include("../partials/admin/footer") %>
