<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= product.productName %> | ZNEAKZ</title>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary: #ff6b6b;
      --primary-dark: #e55b5b;
      --secondary: #f8f8f8;
      --text-primary: #111;
      --text-secondary: #555;
      --border: #ddd;
      --background: #fff;
      --success: #10b981;
      --error: #ef4444;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Source Sans Pro', sans-serif; background:var(--secondary); color:var(--text-primary); line-height:1.5; }
    a { text-decoration:none; color:inherit; }

    /* Breadcrumb */
    .breadcrumb-section { background:var(--background); border-bottom:1px solid var(--border); padding:16px 0; }
    .breadcrumb { max-width:1200px; margin:0 auto; display:flex; gap:8px; font-size:14px; color:var(--text-secondary); }
    .breadcrumb a { color:var(--primary); }
    .breadcrumb a:hover { color:var(--primary-dark); }
    .breadcrumb-separator { color:#999; }

    /* Product Section */
    .product-section { padding:40px 0; }
    .product-container { max-width:1200px; margin:0 auto; background:var(--background); border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .product-layout { display:grid; grid-template-columns:1fr 1fr; gap:48px; padding:40px; }
    @media(max-width:768px){ .product-layout{ grid-template-columns:1fr; padding:24px; } }

    /* Images */
    .image-gallery { display:flex; flex-direction:column; gap:16px; }
.main-image-container { position: relative; overflow: hidden; } 
   .main-image { width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease; cursor:zoom-in; }
    .main-image:hover { transform:scale(1.05); }
    .thumbnail-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(60px,1fr)); gap:12px; margin-top:10px; }
    .thumbnail { aspect-ratio:1; border-radius:8px; overflow:hidden; border:2px solid transparent; cursor:pointer; transition:all 0.2s ease; }
    .thumbnail:hover, .thumbnail.active { border-color:var(--primary); }
    .thumbnail img { width:100%; height:100%; object-fit:cover; }
.zoom-lens {
  position: absolute;
  border: 2px solid var(--primary);
  width: 100px;
  height: 100px;
  visibility: hidden;
  cursor: crosshair;
}
.zoom-result {
  position: absolute;
  border: 1px solid #ccc;
  width: 300px;
  height: 300px;
  top: 0;
  left: 105%;
  background-repeat: no-repeat;
  display: none;
  z-index: 100;
}
    /* Product Info */
    .product-info { display:flex; flex-direction:column; gap:20px; }
    .product-title { font-family:'Playfair Display', serif; font-size:28px; font-weight:600; line-height:1.2; }
    .product-rating { display:flex; align-items:center; gap:8px; color:#fbbf24; }
    .price-section { display:flex; align-items:center; gap:12px; font-size:24px; }
    .current-price { color:var(--primary); font-weight:600; }
    .original-price { text-decoration:line-through; color:#999; font-size:18px; }
    .discount-badge { background:var(--error); color:white; padding:2px 8px; font-size:12px; border-radius:4px; font-weight:500; }

    .product-description { color:var(--text-secondary); font-size:15px; line-height:1.6; }
    .size-section { display:flex; flex-direction:column; gap:8px; }
    .size-options { display:flex; gap:8px; flex-wrap:wrap; }
    .size-btn { padding:6px 12px; border:1px solid var(--border); border-radius:6px; cursor:pointer; transition:all 0.2s; font-weight:500; }
    .size-btn.active, .size-btn:hover { background:var(--primary); color:white; border-color:var(--primary); }

    .quantity-controls { display:flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:6px; width:fit-content; }
    .qty-btn { padding:6px 10px; cursor:pointer; border:none; background:none; font-weight:600; color:var(--text-secondary); }
    .qty-btn:hover { color:var(--primary); }
    .qty-display { padding:6px 12px; min-width:40px; text-align:center; font-weight:600; }

    .action-buttons { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .btn-primary { background:var(--primary); color:white; border:none; padding:12px 20px; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s; flex:1; min-width:120px; }
    .add-to-cart-form { background:var(--primary); color:white; border:none; padding:12px 20px; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.2s; flex:1; min-width:120px; }
    .btn-primary:hover { background:var(--primary-dark); transform:translateY(-1px); }
    .btn-secondary { background:#f5f5f5; color:var(--text-primary); border:1px solid var(--border); padding:12px 20px; border-radius:6px; cursor:pointer; flex:1; min-width:120px; }
    .btn-secondary:hover { background:var(--primary); color:white; }

    /* Related Products */
    .related-section { padding:40px 0; }
    .section-title { text-align:center; font-family:'Playfair Display', serif; font-size:26px; font-weight:600; margin-bottom:32px; }
    .related-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
    .product-card { background:var(--background); border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.08); transition:all 0.2s ease; }
    .product-card:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.12); }
    .card-image { aspect-ratio:1; overflow:hidden; }
    .card-image img { width:100%; height:100%; object-fit:cover; transition:transform 0.3s; }
    .product-card:hover .card-image img { transform:scale(1.05); }
    .card-content { padding:12px; }
    .card-title { font-weight:600; font-size:16px; margin-bottom:6px; }
    .card-price { font-size:14px; color:var(--primary); font-weight:600; margin-bottom:6px; }
    .card-btn { display:block; text-align:center; background:#f5f5f5; padding:6px 0; border-radius:6px; font-size:14px; cursor:pointer; transition:all 0.2s; }
    .card-btn:hover { background:var(--primary); color:white; }
    .main-image-container {
  position: relative;
  overflow: hidden;
  cursor: zoom-in;
}

#mainImage {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.zoom-lens {
  position: absolute;
  width: 100px;
  height: 100px;
  border: 2px solid rgba(0,0,0,0.3);
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(2px);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 10;
  display: none;
}

  </style>
</head>
<body>

  <!-- Breadcrumb -->
  <div class="breadcrumb-section">
    <div class="breadcrumb container">
      <a href="/">Home</a> <span class="breadcrumb-separator">/</span>
      <span><%= product.productName %></span>
    </div>
  </div>

  <!-- Product Section -->
  <div class="product-section">
    <div class="product-container">
      <div class="product-layout">
        
        <!-- Images -->
        <div class="image-gallery">
         <div class="main-image-container">
  <img id="mainImage" src="/uploads/products/<%= product.productImage[0] %>" alt="<%= product.productName %>">
  <div class="zoom-lens" id="zoomLens"></div>
</div>


         <div class="thumbnail-grid">
  <% product.productImage.forEach((img, i) => { %>
    <div class="thumbnail <%= i === 0 ? 'active' : '' %>" 
         onclick="changeMainImage('/uploads/products/<%= img %>', this)">
      <img src="/uploads/products/<%= img %>" alt="Product view <%= i + 1 %>">
    </div>
  <% }) %>
</div>

        </div>

        <!-- Product Info -->
        <div class="product-info">
          <h1 class="product-title"><%= product.productName %></h1>

          <div class="product-rating">
            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
            <span style="color:var(--text-secondary); margin-left:6px;">(25 reviews)</span>
          </div>

          <div class="price-section">
            <% if(product.discountPrice && product.discountPrice < product.price){ %>
              <span class="current-price">₹<%= product.discountPrice %></span>
              <span class="original-price">₹<%= product.price %></span>
              <span class="discount-badge"><%= Math.round(((product.price-product.discountPrice)/product.price)*100) %>% OFF</span>
            <% } else { %>
              <span class="current-price">₹<%= product.price %></span>
            <% } %>
          </div>

          <p class="product-description"><%= product.description %></p>

          <!-- Sizes -->
          <% if(product.sizes && product.sizes.length>0){ %>
            <div class="size-section">
              <label class="section-label">Size:</label>
              <div class="size-options">
                <% product.sizes.forEach((size,i)=>{ %>
                  <button class="size-btn <%= i===0?'active':'' %>" data-size="<%= size %>" onclick="selectSize(this)"><%= size %></button>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Quantity -->
          <div class="size-section">
            <label class="section-label">Quantity:</label>
            <div class="quantity-controls">
              <button class="qty-btn" onclick="decreaseQuantity()">-</button>
              <span class="qty-display" id="quantity">1</span>
              <button class="qty-btn" onclick="increaseQuantity()">+</button>
            </div>
          </div>

          <div id="stockIndicator" style="font-weight:bold; margin-bottom:10px;">
  <% if(product.quantity < 5){ %>
    <span style="color:red;">Less stocks available: <%= product.quantity %></span>
  <% } else { %>
    <span style="color:green;">In stock: <%= product.quantity %></span>
  <% } %>
</div>


          <div class="action-buttons">
            <button class="btn-primary" onclick="buyNow()">Buy Now</button>
<button class="btn-secondary add-to-cart-btn" data-product-id="<%= product._id %>">Add to Cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="related-section">
    <h2 class="section-title">You May Also Like</h2>
    <div class="related-grid container">
      <<% if (relatedProducts && relatedProducts.length > 0) { %>
  <div class="related-grid">
    <% relatedProducts.forEach(prod => { %>
    <% }) %>
  </div>
<% } else { %>
  <p style="text-align: center; color: var(--text-secondary);">No related products found.</p>
<% } %>

    </div>
  </div>

<script>
let selectedSize = null;
let quantity = 1;

function changeMainImage(src, thumbnail) {
  const mainImage = document.getElementById('mainImage');
  mainImage.src = src;

  document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
  thumbnail.classList.add('active');

  initImageZoom();
}

function selectSize(btn){
  document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  selectedSize = btn.dataset.size;
}

function increaseQuantity(){ 
  quantity++; 
  document.getElementById('quantity').textContent = quantity; 
}

function decreaseQuantity(){ 
  if(quantity>1){ 
    quantity--; 
    document.getElementById('quantity').textContent = quantity; 
  } 
}

function addToCart() {
  if (!selectedSize) { 
    alert('Please select a size'); 
    return; 
  }

  const quantityValue = quantity; 
  const productId = document.querySelector('.add-to-cart-btn').dataset.productId;

  fetch('/cart/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ productId, quantity: quantityValue, size: selectedSize })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      let cartIcon = document.querySelector('#cartCount');
      if (!cartIcon) {
        cartIcon = document.createElement('span');
        cartIcon.id = 'cartCount';
        cartIcon.style.color = 'red';
        cartIcon.style.fontWeight = 'bold';
        document.querySelector('a[href="cart"]').appendChild(cartIcon);
      }
      cartIcon.textContent = data.cart.items.length;

      Swal.fire({
        icon: 'success',
        title: 'Added to Cart',
        text: 'Product has been added to your cart',
        timer: 1000,
        showConfirmButton: false
      });
    }
  })
  .catch(err => console.error(err));
}

function buyNow(){
  if(!selectedSize){ alert('Please select a size'); return; }
  alert(`Buying ${quantity} item(s) of size ${selectedSize}`);
}

function initImageZoom() {
  const mainImage = document.getElementById('mainImage');
  const container = document.querySelector('.main-image-container');
  const lens = document.getElementById('zoomLens');

  if (!mainImage || !container || !lens) return;

  container.onmouseenter = null;
  container.onmousemove = null;
  container.onmouseleave = null;

  let zoomEnabled = false;

  container.onmouseenter = () => {
    zoomEnabled = true;
    lens.style.opacity = '1';
  };

  container.onmousemove = (e) => {
    if (!zoomEnabled) return;

    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const constrainedX = Math.max(50, Math.min(container.clientWidth - 50, x));
    const constrainedY = Math.max(50, Math.min(container.clientHeight - 50, y));

    mainImage.style.transformOrigin = `${(constrainedX / container.clientWidth) * 100}% ${(constrainedY / container.clientHeight) * 100}%`;
    mainImage.style.transform = 'scale(2.2)';

    lens.style.left = `${constrainedX - lens.offsetWidth / 2}px`;
    lens.style.top = `${constrainedY - lens.offsetHeight / 2}px`;
  };

  container.onmouseleave = () => {
    zoomEnabled = false;
    mainImage.style.transform = 'scale(1)';
    lens.style.opacity = '0';
  };
}

document.addEventListener('DOMContentLoaded', () => {
  const firstSizeBtn = document.querySelector('.size-btn');
  if(firstSizeBtn){ selectedSize = firstSizeBtn.dataset.size; }

  // Attach Add to Cart button click
  const addBtn = document.querySelector('.add-to-cart-btn');
  if (addBtn) addBtn.addEventListener('click', addToCart);

  // Initialize zoom
  initImageZoom();
});

document.addEventListener("DOMContentLoaded", () => {
  const addToCartBtn = document.querySelector(".add-to-cart-btn");

  if (addToCartBtn) {
    addToCartBtn.addEventListener("click", () => {
      addToCart();
    });
  }
});

  const stockIndicator = document.getElementById('stockIndicator');


  function updateStockIndicator(stock) {
    if(stock < 5){
      stockIndicator.innerHTML = `<span style="color:red;">Less stocks available: ${stock}</span>`;
    } else {
      stockIndicator.innerHTML = `<span style="color:green;">In stock: ${stock}</span>`;
    }
  }

</script>

  <%- include("../partials/user/footer") %>
