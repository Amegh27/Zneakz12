<!-- <%- include("../partials/user/profileHeader") %> -->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
.profile-sidebar {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  min-height: 300px;
  border: 1px solid #eee;
}
.profile-sidebar .user-box {
  background: #111;
  color: #fff;
  padding: 22px;
  text-align: left;
}
.profile-sidebar .user-box img {
  width: 56px;
  height: 56px;
  object-fit: cover;
  border-radius: 50%;
  margin-right: 12px;
}
.profile-sidebar .list-group-item {
  border: none;
  padding: 14px 20px;
}
.profile-main {
  background: #f8f6f6;
  border-radius: 12px;
  padding: 36px;
  min-height: 400px;
}
.section-card {
  background: white;
  border-radius: 12px;
  padding: 28px;
  border: 1px solid #eee;
}
.field-edit {
  position: relative;
}
.field-edit .edit-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  color: #666;
}
.small-muted { color:#6c757d; font-size:0.9rem; }
.profile-avatar {
  position: relative;
  display: inline-block;
  cursor: pointer;
}
.profile-avatar img {
  transition: border-color 0.3s ease;
}
.profile-avatar:hover img {
  border-color: #007bff;
}
.profile-avatar .edit-overlay {
  position: absolute;
  bottom: 5px;
  right: 5px;
  background: rgba(0,0,0,0.6);
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  z-index: 1;
}
.profile-sidebar .profile-avatar .edit-overlay {
  width: 20px;
  height: 20px;
  bottom: 0;
  right: 0;
  font-size: 10px;
}
.profile-avatar .remove-overlay {
  position: absolute;
  bottom: 5px;
  left: 5px;
  background: rgba(220,53,69,0.8);
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
  z-index: 1;
}
.profile-sidebar .profile-avatar .remove-overlay {
  width: 20px;
  height: 20px;
  bottom: 0;
  left: 0;
  font-size: 10px;
}
</style>

<div class="container my-5">
  <div class="row g-4">
    <div class="col-lg-3">
      <div class="profile-sidebar shadow-sm">
        <div class="user-box d-flex align-items-center">
          <div class="profile-avatar">
            <img id="sidebarAvatar" src="<%= user.avatar || '/images/user-avatar.png' %>" alt="" class="rounded-circle" style="width: 56px; height: 56px; object-fit: cover;">
          </div>
          <div>
            <div class="small-muted">Hello</div>
            <div class="fw-bold" style="font-size:1.05rem;"><%= user.name || 'User' %></div>
          </div>
        </div>
        <div class="list-group">
          <a href="/profile" class="list-group-item list-group-item-action active" data-tab="profile">Profile</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="wallet">Wallet</a>
          <a href="/address" class="list-group-item list-group-item-action" data-tab="address">Address</a>
          <a href="#" class="list-group-item list-group-item-action text-danger" data-tab="delete">Delete Account</a>
          <a href="/help" class="list-group-item list-group-item-action">Help</a>
          <a href="/logout" class="list-group-item list-group-item-action">Logout</a>
        </div>
      </div>
    </div>

    <!-- Main Section -->
    <div class="col-lg-9">
      <div class="profile-main">
        <!-- PROFILE SECTION -->
        <div id="tab-profile" class="section-card">
          <h4 class="text-center fw-bold mb-4">PROFILE</h4>

          <form id="profileForm" action="/profile/edit" method="POST" enctype="multipart/form-data" class="row g-3">
            <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;">
            <input type="hidden" id="removeAvatarFlag" name="remove_avatar" value="0">

            <div class="col-12 text-center mb-4">
              <div class="profile-avatar">
                <img id="avatarPreview" src="<%= user.avatar || '/images/user-avatar.png' %>" alt="" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #eee;">
                <i class="bi bi-pencil edit-overlay" title="Change Profile Picture"></i>
                <% if (user.avatar) { %>
                  <i class="bi bi-x-lg remove-overlay" title="Remove Profile Picture"></i>
                <% } %>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">Name</label>
              <div class="field-edit">
                <input type="text" name="name" class="form-control" value="<%= user.name || '' %>" required>
                <i class="bi bi-pencil edit-icon" title="Edit"></i>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">Email</label>
              <div class="field-edit">
                <input type="email" name="email" class="form-control" value="<%= user.email || '' %>" required>
                <i class="bi bi-pencil edit-icon" title="Edit"></i>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">Phone</label>
              <div class="field-edit">
                <input type="text" name="phone" class="form-control" value="<%= user.phone || '' %>">
                <i class="bi bi-pencil edit-icon" title="Edit"></i>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">Gender</label>
              <div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="g-female" value="Female" <%= user.gender === 'Female' ? 'checked' : '' %>>
                  <label class="form-check-label" for="g-female">Female</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="g-male" value="Male" <%= user.gender === 'Male' ? 'checked' : '' %>>
                  <label class="form-check-label" for="g-male">Male</label>
                </div>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center mt-3">
              <a href="/change-password" class="btn btn-dark">Change password</a>
              <button type="submit" class="btn btn-dark">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div> <!-- END .col-lg-9 -->

  </div> <!-- END .row -->
</div> <!-- END .container -->

<%- include("../partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.querySelectorAll('.profile-sidebar .list-group-item').forEach(link => {
  link.addEventListener('click', (e) => {
    const href = link.getAttribute('href');

    if (href === '#' || href === '') {
      e.preventDefault();

      document.querySelectorAll('.profile-sidebar .list-group-item')
        .forEach(i => i.classList.remove('active'));
      link.classList.add('active');

      const tab = link.getAttribute('data-tab');
      document.querySelectorAll('[id^="tab-"]').forEach(sec => sec.style.display = 'none');
      const target = document.getElementById('tab-' + tab);
      if (target) target.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
});

  // Avatar logic
  const avatarInput = document.getElementById('avatarInput');
  const sidebarAvatar = document.getElementById('sidebarAvatar');
  const avatarPreview = document.getElementById('avatarPreview');
  const removeAvatarFlag = document.getElementById('removeAvatarFlag');
  const defaultAvatar = '/images/user-avatar.png';

  document.querySelectorAll('.edit-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      e.stopPropagation();
      avatarInput.click();
      removeAvatarFlag.value = '0';
    });
  });

  document.querySelectorAll('.remove-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm('Are you sure you want to remove your profile picture?')) {
        if (sidebarAvatar) sidebarAvatar.src = defaultAvatar;
        if (avatarPreview) avatarPreview.src = defaultAvatar;
        avatarInput.value = '';
        removeAvatarFlag.value = '1';
      }
    });
  });

  avatarInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        alert('File size must be less than 2MB');
        e.target.value = '';
        return;
      }
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        e.target.value = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        if (sidebarAvatar) sidebarAvatar.src = e.target.result;
        if (avatarPreview) avatarPreview.src = e.target.result;
        removeAvatarFlag.value = '0';
      };
      reader.readAsDataURL(file);
    }
  });

  // Profile form AJAX
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const formData = new FormData(form);

    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    try {
      const res = await fetch('/profile/edit', {
        method: 'POST',
        body: formData
      });
      const json = await res.json();

      if (json.success) {
        Swal.fire('Success', 'Profile updated successfully!', 'success').then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire('Error', json.message || 'Could not update profile', 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'Server error', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save changes';
    }
  });
</script>