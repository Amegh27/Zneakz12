<%- include("../partials/user/header2") %>

<head>
  <meta charset="UTF-8">
  <title>Checkout - ZNEAKZ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      color: #1a202c;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h3 {
      font-size: 2.8rem;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -0.8px;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .checkout-subtitle {
      text-align: center;
      color: #64748b;
      font-size: 0.95rem;
      margin-bottom: 3rem;
    }

    h4, h5 {
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
    }

    /* Modern section cards with gradient shadows */
    .section-card {
      background: white;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(203, 213, 225, 0.5);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .section-card:hover {
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
      transform: translateY(-2px);
    }

    /* Enhanced form controls */
    .form-control {
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      background: #f8fafc;
    }

    .form-control:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      background: white;
    }

    .form-control::placeholder {
      color: #94a3b8;
    }

    /* Attractive add address section */
    .add-address-section {
      border: 2px dashed #cbd5e1;
      border-radius: 14px;
      padding: 2.5rem;
      text-align: center;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(226, 232, 240, 0.5) 0%, rgba(241, 245, 249, 0.8) 100%);
    }

    .add-address-section:hover {
      border-color: #0ea5e9;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(14, 165, 233, 0.04) 100%);
      transform: translateY(-1px);
    }

    .add-address-section i {
      font-size: 2.5rem;
      color: #0ea5e9;
      margin-bottom: 1rem;
      display: block;
    }

    .add-address-section strong {
      color: #1e293b;
      font-size: 1.1rem;
    }

    .add-address-section p {
      color: #64748b;
      margin-top: 0.5rem;
    }

    /* Enhanced address items */
    .address-item {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.5rem 1.5rem 1.5rem 3rem;
      margin-bottom: 1rem;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .address-item:hover {
      border-color: #0ea5e9;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.12);
      background: white;
    }

    .address-item.default-address {
      border-color: #0ea5e9;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(14, 165, 233, 0.02) 100%);
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.08);
    }

    .address-radio {
      position: absolute;
      left: 1rem;
      top: 1.5rem;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #0ea5e9;
    }

    .address-item strong {
      color: #1e293b;
      font-size: 1.05rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .address-item .small {
      color: #64748b;
      display: block;
      margin: 0.3rem 0;
    }

    .address-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .address-actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-edit {
      background: #0ea5e9;
      color: white;
      border: none;
    }

    .btn-edit:hover {
      background: #0284c7;
      transform: translateY(-1px);
    }

    .btn-delete {
      background: #ef4444;
      color: white;
      border: none;
    }

    .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* Primary buttons with modern styling */
    .btn-dark {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: none;
      font-weight: 700;
      border-radius: 10px;
      padding: 0.8rem 1.75rem;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .btn-dark:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.25);
    }

    .btn-dark:active {
      transform: translateY(0);
    }

    .btn-outline-dark {
      border: 2px solid #e2e8f0;
      color: #1e293b;
      font-weight: 600;
      border-radius: 10px;
      padding: 0.65rem 1.5rem;
      transition: all 0.2s ease;
      background: white;
    }

    .btn-outline-dark:hover {
      background: #f8fafc;
      border-color: #0ea5e9;
      color: #0ea5e9;
    }

    .btn-secondary {
      background: #e2e8f0;
      border: none;
      color: #475569;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
      color: #1e293b;
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      border: none;
      font-weight: 700;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
    }

    /* Card styling for order summary */
    .card {
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.06);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
    }

    .card-body {
      padding: 2rem;
      background: white;
    }

    .border-bottom {
      border-bottom: 1px solid #e2e8f0 !important;
      padding: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .border-bottom img {
      border-radius: 8px;
      margin-right: 1rem;
      object-fit: cover;
      border: 1px solid #e2e8f0;
    }

    .border-bottom span {
      font-size: 0.95rem;
      color: #1e293b;
    }

    hr {
      border: none;
      border-top: 1px solid #e2e8f0;
      margin: 1.5rem 0;
    }

    /* Coupon section styling */
    .coupon-section {
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(59, 130, 246, 0.05) 100%);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .coupon-section h6 {
      color: #0f172a;
      font-weight: 700;
    }

    .input-group .form-control {
      border: 2px solid #e2e8f0;
    }

    .coupon-card {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      background: white;
      transition: all 0.2s ease;
    }

    .coupon-card:hover {
      border-color: #0ea5e9;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.12);
    }

    .coupon-card strong {
      color: #1e293b;
      font-size: 1rem;
    }

    .coupon-card .text-muted {
      color: #64748b;
    }

    /* Price display styling */
    .d-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      font-size: 0.95rem;
    }

    .d-flex span {
      color: #64748b;
    }

    .d-flex strong {
      color: #0f172a;
      font-weight: 700;
    }

    .text-success {
      color: #10b981 !important;
    }

    .alert-success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #047857;
      border-radius: 10px;
    }

    /* Wallet section styling */
    .wallet-section {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(14, 165, 233, 0.05) 100%);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid rgba(14, 165, 233, 0.2);
      margin-top: 1.5rem;
    }

    #walletSummary {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      border-left: 3px solid #0ea5e9;
      margin: 1rem 0;
    }

    .text-muted {
      color: #64748b;
    }

    .text-center {
      text-align: center;
    }

    p {
      color: #64748b;
      font-size: 0.95rem;
    }

    .text-danger {
      color: #ef4444;
      font-weight: 600;
    }

    /* Modal styling */
    .modal-content {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
    }

    .modal-header {
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 1.5rem;
    }

    .modal-title {
      font-weight: 700;
      color: #0f172a;
    }

    .py-5 {
      padding: 3rem 1rem !important;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .section-card {
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      h3 {
        font-size: 2rem;
      }

      h4, h5 {
        font-size: 1.1rem;
      }

      .address-item {
        padding: 1rem 1rem 1rem 2.5rem;
      }

      .address-actions {
        flex-direction: column;
        gap: 0.5rem;
      }

      .address-actions .btn {
        width: 100%;
      }

      .d-flex {
        flex-direction: column;
        align-items: flex-start;
      }

      .border-bottom {
        flex-direction: column;
        align-items: flex-start;
      }

      .border-bottom img {
        margin-right: 0;
        margin-bottom: 1rem;
      }
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-5">
    <h3>Checkout</h3>
    <p class="checkout-subtitle">Complete your purchase securely</p>

    <div class="row">
      <!-- LEFT: Address -->
      <div class="col-md-6 section-card mb-4">
        <h4><i class="bi bi-geo-alt me-2" style="color:#0ea5e9;"></i>Delivery Address</h4>

        <div id="addAddressTrigger" class="add-address-section" style="cursor:pointer;">
          <i class="bi bi-plus-circle"></i>
          <strong>Add New Address</strong>
          <p>Click to add a new delivery address</p>
        </div>

        <form id="addAddressForm" class="mb-3" style="display:none;">
          <div class="row g-3">
            <div class="col-6"><input class="form-control" name="name" placeholder="Full Name" value="<%= user.name || '' %>" required></div>
            <div class="col-6"><input class="form-control" name="phone" placeholder="Phone Number" value="<%= user.phone || '' %>" maxlength="10" required></div>
            <div class="col-12"><input class="form-control" name="address" placeholder="Street Address" maxlength="100" required></div>
            <div class="col-6"><input class="form-control" name="city" placeholder="City" maxlength="40" required></div>
            <div class="col-6"><input class="form-control" name="state" placeholder="State" maxlength="40" required></div>
            <div class="col-6"><input class="form-control" name="pincode" placeholder="Pincode" maxlength="6" required></div>
            <div class="col-12 text-end">
              <button type="button" id="cancelAddBtn" class="btn btn-secondary me-2">Cancel</button>
              <button type="submit" class="btn btn-dark">Add Address</button>
            </div>
          </div>
        </form>

        <% if (addresses && addresses.length) { %>
          <ul class="p-0" style="list-style:none;">
            <% addresses.forEach((addr, idx) => { %>
              <li class="address-item <%= idx === 0 ? 'default-address' : '' %>">
                <input class="form-check-input address-radio" type="radio" name="selectedAddress" value="<%= addr._id %>" <%= idx === 0 ? 'checked' : '' %> />
                <div>
                  <strong><i class="bi bi-check-circle-fill me-2" style="color:#0ea5e9;display:<%= idx === 0 ? 'inline' : 'none' %>;"></i><%= addr.name %></strong>
                  <div class="small"><%= addr.address %></div>
                  <div class="small"><%= addr.city %>, <%= addr.state %> - <%= addr.pincode %></div>
                </div>
                <div class="address-actions">
                  <button class="btn btn-sm btn-edit" data-id="<%= addr._id %>"><i class="bi bi-pencil me-1"></i>Edit</button>
                  <button class="btn btn-sm btn-delete" data-id="<%= addr._id %>"><i class="bi bi-trash me-1"></i>Delete</button>
                </div>
                <form class="address-edit-form mt-3" style="display:none;">
                  <input type="hidden" name="addressId" value="<%= addr._id %>">
                  <div class="row g-2">
                    <div class="col-6"><input class="form-control" name="name" value="<%= addr.name %>" required></div>
                    <div class="col-6"><input class="form-control" name="phone" value="<%= user.phone || '' %>" maxlength="10" required></div>
                    <div class="col-12"><input class="form-control" name="address" value="<%= addr.address %>" maxlength="100" required></div>
                    <div class="col-6"><input class="form-control" name="city" value="<%= addr.city %>" maxlength="40" required></div>
                    <div class="col-6"><input class="form-control" name="state" value="<%= addr.state %>" maxlength="40" required></div>
                    <div class="col-6"><input class="form-control" name="pincode" value="<%= addr.pincode %>" maxlength="6" required></div>
                    <div class="col-12 text-end">
                      <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn">Cancel</button>
                      <button type="submit" class="btn btn-dark btn-sm save-edit-btn">Save Changes</button>
                    </div>
                  </div>
                </form>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-center py-4" style="color:#94a3b8;">
            <i class="bi bi-geo-alt" style="font-size:2.5rem;color:#cbd5e1;"></i>
            <div class="mt-3" style="color:#64748b;">No addresses added yet</div>
          </div>
        <% } %>
      </div>

      <div class="col-md-6">
        <h5><i class="bi bi-bag-check me-2" style="color:#000000;"></i>Order Summary</h5>
        <div class="card">
          <div class="card-body">
            <% if (cart && cart.items && cart.items.length) { %>
              <% cart.items.forEach(item => { %>
                <div class="border-bottom">
                  <div style="display:flex;align-items:center;width:100%;">
                    <img src="/uploads/products/<%= item.product.productImage[0] %>" width="60" height="60" alt="<%= item.product.productName %>">
                    <div>
                      <strong><%= item.product.productName %></strong>
                      <div class="small text-muted">Qty: <%= item.quantity %></div>
                    </div>
                  </div>
                  <div style="text-align:right;font-weight:700;color:#0f172a;">₹<%= ((item.product.discountPrice || item.product.price) * item.quantity).toFixed(0) %></div>
                </div>
              <% }) %>

              <hr>

              <div class="coupon-section">
                <div class="d-flex" style="justify-content:space-between;border:none;padding:0;">
                  <h6 class="mb-0"><i class="bi bi-ticket me-2" style="color:#0ea5e9;"></i>Have a Coupon?</h6>
                  <button type="button" id="viewCouponsBtn" class="btn btn-outline-dark btn-sm">View Coupons</button>
                </div>

                <div class="input-group mt-3">
                  <input type="text" id="couponCodeInput" class="form-control" placeholder="Enter coupon code" value="<%= appliedCoupon ? appliedCoupon.code : '' %>">
                  <% if (appliedCoupon) { %>
                    <button class="btn btn-secondary" id="removeCouponBtn"><i class="bi bi-x"></i></button>
                  <% } else { %>
                    <button class="btn btn-dark" id="applyCouponBtn">Apply</button>
                  <% } %>
                </div>

                <% if (appliedCoupon) { %>
                  <div class="alert alert-success mt-2 mb-0">
                    <i class="bi bi-check-circle me-2"></i>Coupon <strong><%= appliedCoupon.code %></strong> applied! You saved ₹<%= discountAmount.toFixed(0) %>
                  </div>
                <% } %>
              </div>

              <hr>

              <div class="d-flex" style="border:none;"><span>Subtotal:</span><span>₹<%= subtotal.toFixed(0) %></span></div>
              <div class="d-flex" style="border:none;"><span>Tax (5%):</span><span>₹<%= tax.toFixed(0) %></span></div>
              <div class="d-flex" style="border:none;"><span>Shipping:</span><span>₹<%= shipping %></span></div>
              <% if (appliedCoupon) { %>
                <div class="d-flex text-success" style="border:none;"><span>Coupon Discount:</span><span>-₹<%= discountAmount.toFixed(0) %></span></div>
              <% } %>
              <hr>
              <div class="d-flex" style="border:none;font-size:1.2rem;"><strong>Total Amount:</strong><strong>₹<%= finalTotal.toFixed(0) %></strong></div>

              <div class="wallet-section">
                <button id="useWalletBtn" class="btn btn-outline-dark w-100">
                  <i class="bi bi-wallet2 me-2"></i> Use Wallet Balance (₹<%= (user.wallet && user.wallet.balance) ? user.wallet.balance.toFixed(0) : 0 %>)
                </button>
                <div id="walletSummary" style="display:none;">
                  <div><strong>Wallet Applied:</strong> <span id="walletApplied">₹0</span></div>
                  <div><strong>Remaining to Pay:</strong> <span id="remainingAmount">₹<%= finalTotal.toFixed(2) %></span></div>
                </div>
                <button id="payWithWalletBtn" class="btn btn-success w-100 mt-3" style="display:none"><i class="bi bi-wallet2 me-2"></i> Complete with Wallet</button>
              </div>

              <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

              <div class="mt-4 d-grid gap-2">
                <button id="razorpayBtn" class="btn btn-dark py-2"><i class="bi bi-credit-card me-2"></i>Pay with Razorpay</button>
                <button id="placeOrderBtn" class="btn btn-outline-dark py-2" style="<%= finalTotal > 1000 ? 'background:#f1f5f9;color:#94a3b8;cursor:not-allowed;opacity:.5;border-color:#cbd5e1' : '' %>" <%= finalTotal > 1000 ? 'disabled' : '' %>>
                  <i class="bi bi-cash-coin me-2"></i>Place Order (COD)
                </button>
                <% if (finalTotal > 1000) { %>
                  <p class="text-danger text-center mt-2"><i class="bi bi-info-circle me-2"></i>COD not available for orders above ₹1000</p>
                <% } %>
              </div>

            <% } else { %>
              <div class="text-center py-5">
                <i class="bi bi-cart-x" style="font-size:3rem;color:#cbd5e1;"></i>
                <p class="mt-3" style="color:#94a3b8;">Your cart is empty</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="couponModalLabel"><i class="bi bi-ticket-perforated me-2" style="color:#0ea5e9;"></i>Available Coupons</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="couponModalBody">
          <% if (typeof coupons !== 'undefined' && coupons && coupons.length) { %>
            <% coupons.forEach(c => { %>
              <div class="coupon-card">
                <div><strong><%= c.code %></strong></div>
                <div class="small text-muted"><%= c.name || c.description || '' %></div>
                <div class="small text-muted">Min Purchase: ₹<%= c.minPurchase || 0 %></div>
                <button class="btn btn-sm btn-dark mt-2 applyThisCoupon" data-code="<%= c.code %>">Apply Coupon</button>
              </div>
            <% }) %>
          <% } else { %>
            <div class="text-center py-4">
              <i class="bi bi-inbox" style="font-size:2rem;color:#cbd5e1;"></i>
              <p class="text-muted mt-3">No coupons available</p>
              <button id="fetchCouponsBtn" class="btn btn-dark btn-sm">Fetch Coupons</button>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const serverData = {
      addresses: <%- JSON.stringify(addresses || []) %>,
      cartItems: <%- JSON.stringify(cart && cart.items ? cart.items.map(i => ({ productId: i.product._id, quantity: i.quantity, price: i.product.discountPrice || i.product.price })) : []) %>,
      totalAmount: Number(<%= finalTotal %> || 0),
      walletBalance: Number(<%= (user.wallet && user.wallet.balance) ? user.wallet.balance : 0 %>)
    };

    document.getElementById('addAddressTrigger')?.addEventListener('click', () => {
      document.getElementById('addAddressTrigger').style.display = 'none';
      document.getElementById('addAddressForm').style.display = 'block';
    });

    document.getElementById('cancelAddBtn')?.addEventListener('click', () => {
      document.getElementById('addAddressForm').reset();
      document.getElementById('addAddressForm').style.display = 'none';
      document.getElementById('addAddressTrigger').style.display = 'block';
    });

    function validateAddressObj(a) {
      if (!a.name || a.name.trim().length < 2) return "Name must be at least 2 characters";
      if (!/^[6-9]\d{9}$/.test(a.phone || '')) return "Enter a valid 10-digit phone number";
      if (!a.address || a.address.trim().length === 0) return "Address is required";
      if (!a.city || !a.state) return "City and State are required";
      if (!/^\d{6}$/.test(a.pincode || '')) return "Pincode must be exactly 6 digits";
      return null;
    }

    document.getElementById('addAddressForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = Object.fromEntries(new FormData(form).entries());
      const err = validateAddressObj(formData);
      if (err) return Swal.fire('Error', err, 'error');

      const btn = form.querySelector('button[type="submit"]');
      const orig = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = 'Adding...';

      try {
        const res = await fetch('/address', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        if (data.success) {
          Swal.fire('Added', data.message || 'Address added.', 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', data.message || 'Failed to add address', 'error');
        }
      } catch (err) {
        Swal.fire('Error', 'Server error. Try again.', 'error');
      } finally {
        btn.disabled = false; btn.innerHTML = orig;
      }
    });

    document.addEventListener('click', async (e) => {
      if (e.target.matches('.cancel-edit-btn')) {
        const form = e.target.closest('.address-item').querySelector('.address-edit-form');
        form.style.display = 'none';
      }

      if (e.target.matches('.btn-edit')) {
        const li = e.target.closest('.address-item');
        li.querySelector('.address-edit-form').style.display = 'block';
      }

      if (e.target.matches('.btn-delete')) {
        const id = e.target.dataset.id;
        const confirm = await Swal.fire({ icon: 'warning', title: 'Delete Address?', showCancelButton: true });
        if (!confirm.isConfirmed) return;
        try {
          const res = await fetch(`/address/delete/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) Swal.fire('Deleted', data.message || 'Address deleted', 'success').then(() => location.reload());
          else Swal.fire('Error', data.message || 'Delete failed', 'error');
        } catch (err) { Swal.fire('Error', 'Server error', 'error'); }
      }
    });

    document.addEventListener('submit', async (e) => {
      if (!e.target.matches('.address-edit-form')) return;
      e.preventDefault();
      const form = e.target;
      const fd = Object.fromEntries(new FormData(form).entries());
      const err = validateAddressObj(fd);
      if (err) return Swal.fire('Error', err, 'error');

      const btn = form.querySelector('.save-edit-btn');
      const orig = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = 'Saving...';
      try {
        const res = await fetch(`/address/edit/${fd.addressId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fd)
        });
        const data = await res.json();
        if (data.success) Swal.fire('Saved', data.message || 'Address updated', 'success').then(() => location.reload());
        else Swal.fire('Error', data.message || 'Update failed', 'error');
      } catch (err) { Swal.fire('Error', 'Server error', 'error'); }
      finally { btn.disabled = false; btn.innerHTML = orig; }
    });

    const couponModalEl = document.getElementById('couponModal');
    const couponModal = couponModalEl ? new bootstrap.Modal(couponModalEl) : null;

    document.getElementById('viewCouponsBtn')?.addEventListener('click', () => {
      if (couponModal) couponModal.show();
    });

    document.getElementById('fetchCouponsBtn')?.addEventListener('click', async () => {
      try {
        const res = await fetch('/checkout/available-coupons');
        const data = await res.json();
        if (!data.success || !data.coupons || !data.coupons.length) return Swal.fire('No Coupons', 'No active coupons available.', 'info');

        const body = document.getElementById('couponModalBody');
        body.innerHTML = data.coupons.map(c => `
          <div class="coupon-card d-flex justify-content-between align-items-start">
            <div>
              <strong>${c.code}</strong><br>
              <small class="text-muted">${c.name || c.description || ''}</small><br>
              <small class="text-muted">Min Purchase: ₹${c.minPurchase || 0}</small>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-dark applyThisCoupon" data-code="${c.code}">Apply</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        Swal.fire('Error', 'Unable to fetch coupons', 'error');
      }
    });

    document.addEventListener('click', async (e) => {
      if (e.target.matches('.applyThisCoupon')) {
        const code = e.target.dataset.code;
        document.getElementById('couponCodeInput').value = code;
        if (couponModal) couponModal.hide();
      }
    });

    document.getElementById('applyCouponBtn')?.addEventListener('click', async () => {
      const code = (document.getElementById('couponCodeInput').value || '').trim();
      if (!code) return Swal.fire('Enter Coupon', 'Please enter a coupon code.', 'warning');
      const btn = document.getElementById('applyCouponBtn');
      btn.disabled = true; const orig = btn.innerHTML; btn.innerHTML = 'Applying...';
      try {
        const res = await fetch('/checkout/apply-coupon', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        if (data.success) Swal.fire('Success', data.message || 'Coupon applied', 'success').then(() => location.reload());
        else Swal.fire('Invalid Coupon', data.message || 'Coupon could not be applied', 'error');
      } catch (err) { Swal.fire('Error', 'Server error applying coupon', 'error'); }
      finally { btn.disabled = false; btn.innerHTML = orig; }
    });

    document.getElementById('removeCouponBtn')?.addEventListener('click', async () => {
      try {
        const res = await fetch('/checkout/remove-coupon', { method: 'DELETE' });
        const data = await res.json();
        if (data.success) Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Coupon removed', timer:1400, showConfirmButton:false }).then(()=>location.reload());
        else Swal.fire('Error', data.message || 'Failed to remove coupon', 'error');
      } catch (err) { Swal.fire('Error', 'Server error', 'error'); }
    });

    const useWalletBtn = document.getElementById('useWalletBtn');
    const walletSummary = document.getElementById('walletSummary');
    const walletApplied = document.getElementById('walletApplied');
    const remainingAmount = document.getElementById('remainingAmount');
    const payWithWalletBtn = document.getElementById('payWithWalletBtn');

    let walletToggle = false;

    function updateWalletUI() {
      const total = serverData.totalAmount;
      if (!walletToggle) {
        walletSummary.style.display = 'none';
        payWithWalletBtn.style.display = 'none';
        useWalletBtn.classList.remove('btn-success');
        useWalletBtn.classList.add('btn-outline-dark');
        useWalletBtn.innerHTML = `<i class="bi bi-wallet2 me-2"></i> Use Wallet Balance (₹${Math.round(serverData.walletBalance)})`;
        walletApplied.innerText = '₹0';
        remainingAmount.innerText = `₹${total.toFixed(2)}`;
        return;
      }

      const use = Math.min(serverData.walletBalance, total);
      const remain = +(total - use).toFixed(2);
      walletApplied.innerText = `₹${use.toFixed(2)}`;
      remainingAmount.innerText = `₹${remain.toFixed(2)}`;
      walletSummary.style.display = 'block';
      useWalletBtn.classList.remove('btn-outline-dark');
      useWalletBtn.classList.add('btn-success');
      useWalletBtn.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> Wallet Applied`;

      if (remain === 0) {
        payWithWalletBtn.style.display = 'block';
        document.getElementById('razorpayBtn').style.display = 'none';
        document.getElementById('placeOrderBtn').style.display = 'none';
      } else {
        payWithWalletBtn.style.display = 'none';
        document.getElementById('razorpayBtn').style.display = 'block';
        document.getElementById('placeOrderBtn').style.display = 'block';
      }
    }

    useWalletBtn?.addEventListener('click', () => {
      walletToggle = !walletToggle;
      updateWalletUI();
    });

    payWithWalletBtn?.addEventListener('click', async () => {
      const addr = document.querySelector("input[name='selectedAddress']:checked")?.value;
      if (!addr) return Swal.fire('Error', 'Please select an address', 'error');

      try {
        const res = await fetch('/checkout/pay-wallet', {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ addressId: addr })
        });
        const data = await res.json();
        if (data.success) window.location.href = data.redirect;
        else Swal.fire('Error', data.message || 'Wallet payment failed', 'error');
      } catch (err) { Swal.fire('Error', 'Server error', 'error'); }
    });

    document.getElementById('placeOrderBtn')?.addEventListener('click', async () => {
      const addr = document.querySelector("input[name='selectedAddress']:checked")?.value;
      if (!addr) return Swal.fire('Error', 'Please select an address', 'error');
      if (serverData.totalAmount > 1000) return Swal.fire('COD Unavailable', 'Cash on Delivery not allowed for orders above ₹1000', 'warning');

      try {
        const res = await fetch('/checkout/place-order', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ addressId: addr, useWallet: walletToggle })
        });
        const data = await res.json();
        if (data.success) window.location.href = data.redirect;
        else Swal.fire('Error', data.message || 'Order failed', 'error');
      } catch (err) { Swal.fire('Error', 'Server error', 'error'); }
    });

    document.getElementById('razorpayBtn')?.addEventListener('click', async () => {
      const selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked')?.value;
      if (!selectedAddressId) return Swal.fire('Error', 'Please select an address', 'error');

      const walletToUse = walletToggle ? Math.min(serverData.walletBalance, serverData.totalAmount) : 0;
      const amountToPay = +(serverData.totalAmount - walletToUse).toFixed(2);
      if (amountToPay <= 0) return Swal.fire('Info', 'No amount left to pay with Razorpay', 'info');

      try {
        const createRes = await fetch('/create-razorpay-order', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ totalAmount: amountToPay })
        });
        const createData = await createRes.json();
        if (!createData.success) return Swal.fire('Error', createData.message || 'Unable to create payment', 'error');

        const options = {
          key: createData.key,
          amount: createData.amount * 100,
          currency: 'INR',
          name: 'ZNEAKZ',
          order_id: createData.orderId,
          handler: async function(response) {
            try {
              const orderDetails = {
                items: serverData.cartItems,
                addressId: selectedAddressId,
                totalAmount: serverData.totalAmount,
                walletUsed: walletToUse,
                paymentMethod: 'Razorpay'
              };
              const verifyRes = await fetch('/verify-payment', {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                  orderDetails
                })
              });
              const verifyData = await verifyRes.json();
              if (verifyData.success) window.location.href = verifyData.redirect;
              else {
                if (verifyData.couponRemoved) {
                  Swal.fire('Coupon Invalid', verifyData.message || 'Coupon removed', 'error').then(()=>location.reload());
                } else Swal.fire('Error', verifyData.message || 'Payment verification failed', 'error');
              }
            } catch (err) { Swal.fire('Error', 'Verification failed', 'error'); }
          },
          modal: { ondismiss: function(){  } },
          theme: { color: '#000' }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function(resp){
          Swal.fire('Payment Failed', resp.error.description || 'Payment failed', 'error');
        });
        rzp.open();
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'Unable to start Razorpay payment', 'error');
      }
    });

    updateWalletUI();
  </script>

  <%- include("../partials/user/footer") %>
</body>
