<%- include("../partials/user/header2") %>

<head>
  <meta charset="UTF-8">
  <title>Checkout - ZNEAKZ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - ZNEAKZ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Enhanced black and white styling for checkout page */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      color: #1a1a1a;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h3 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #000;
      letter-spacing: -0.5px;
      margin-bottom: 3rem !important;
    }

    h4, h5 {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 1.5rem;
    }

    .section-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #e8e8e8;
      transition: all 0.3s ease;
    }

    .section-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .form-check {
      padding: 1rem;
      border-radius: 8px;
      background: #fafafa;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .form-check:hover {
      background: #f0f0f0;
      border-color: #d0d0d0;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      margin-top: 0.3rem;
      cursor: pointer;
      border: 2px solid #ccc;
      accent-color: #000;
    }

    .form-check-input:checked {
      background-color: #000;
      border-color: #000;
    }

    .form-check-label {
      cursor: pointer;
      margin-left: 0.5rem;
      font-size: 0.95rem;
    }

    .btn-outline-dark {
      border: 2px solid #000;
      color: #000;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.6rem 1.5rem;
      transition: all 0.3s ease;
    }

    .btn-outline-dark:hover {
      background-color: #000;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-dark {
      background-color: #000;
      border: none;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.7rem 1.5rem;
      transition: all 0.3s ease;
    }

    .btn-dark:hover {
      background-color: #1a1a1a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background-color: #e8e8e8;
      border: none;
      color: #1a1a1a;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #d0d0d0;
      color: #000;
    }

    .btn-primary {
      background-color: #000;
      border: none;
      font-weight: 700;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #1a1a1a;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .card {
      border: 1px solid #e8e8e8;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .card-body {
      padding: 2rem;
      background: white;
    }

    .d-flex {
      display: flex;
      align-items: center;
    }

    .d-flex.justify-content-between {
      justify-content: space-between;
    }

    .border-bottom {
      border-bottom: 1px solid #e8e8e8 !important;
      padding: 1rem 0;
    }

    .border-bottom img {
      border-radius: 6px;
      margin-right: 1rem;
      object-fit: cover;
    }

    .border-bottom span {
      font-size: 0.95rem;
      color: #1a1a1a;
    }

    hr {
      border: none;
      border-top: 2px solid #e8e8e8;
      margin: 1.5rem 0;
    }

    #newAddressModal {
      background: rgba(0, 0, 0, 0.5);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #newAddressModal form {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .form-control {
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      border-color: #000;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .py-5 {
      padding: 3rem 1rem !important;
    }

    .text-center {
      text-align: center;
    }

    p {
      color: #666;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>


</body>
</html>

</head>
<body class="bg-light">

<div class="container py-5">
  <h3 class="mb-4 text-center">Checkout</h3>

  <div class="row">
    <!-- Addresses -->
    <div class="col-md-6 checkout-address-section section-card mb-4">
      <h4>Delivery Address</h4>

      <% if(addresses && addresses.length > 0) { %>
        <% addresses.forEach((addr, index) => { %>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="selectedAddress" id="addr<%= index %>" value="<%= index %>" <%= index === 0 ? 'checked' : '' %>>
            <label class="form-check-label" for="addr<%= index %>">
              <strong><%= addr.name %></strong>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %>
            </label>
          </div>
        <% }) %>
      <% } else { %>
        <p>No address found. Please add a new address.</p>
      <% } %>

      <button type="button" id="addNewAddressBtn" class="btn btn-outline-dark mt-2">Add New Address</button>

      <!-- New Address Form Modal -->
      <div id="newAddressModal" style="display:none;">
        <form id="newAddressForm" class="p-3 border rounded bg-white mt-3">
          <h5 class="mb-3">Add New Address</h5>
          <input type="text" name="name" placeholder="Full Name" class="form-control mb-2" required>
          <input type="text" name="phone" placeholder="Phone" class="form-control mb-2" required>
          <input type="text" name="street" placeholder="Street" class="form-control mb-2" required>
          <input type="text" name="city" placeholder="City" class="form-control mb-2" required>
          <input type="text" name="state" placeholder="State" class="form-control mb-2" required>
          <input type="text" name="pincode" placeholder="Pincode" class="form-control mb-2" required>
          <div class="form-check mb-2">
            <input type="checkbox" name="isDefault" class="form-check-input" id="defaultCheck">
            <label class="form-check-label" for="defaultCheck">Set as default</label>
          </div>
          <button type="submit" class="btn btn-dark">Save Address</button>
          <button type="button" id="closeAddressModal" class="btn btn-secondary ms-2">Cancel</button>
        </form>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-6">
      <h5>Order Summary</h5>
      <div class="card">
        <div class="card-body">
          <% if(cart && cart.items.length > 0) { %>
            <% cart.items.forEach(item => { %>
              <div class="d-flex justify-content-between border-bottom py-2">
                <div>
                  <img src="/uploads/products/<%= item.product.productImage[0] %>" width="50" height="50">
                  <span><%= item.product.productName %> (x<%= item.quantity %>)</span>
                </div>
                <div>₹<%= (item.product.discountPrice || item.product.price) * item.quantity %></div>
              </div>
            <% }) %>

            <hr>
            <div class="d-flex justify-content-between"><span>Subtotal:</span><span>₹<%= subtotal %></span></div>
            <div class="d-flex justify-content-between"><span>Tax (5%):</span><span>₹<%= tax.toFixed(2) %></span></div>
            <div class="d-flex justify-content-between"><span>Shipping:</span><span>₹<%= shipping %></span></div>
            <div class="d-flex justify-content-between"><strong>Total:</strong><strong>₹<%= finalTotal.toFixed(2) %></strong></div>

            <button id="placeOrderBtn" class="btn btn-primary w-100 mt-3">Place Order (COD)</button>
          <% } else { %>
            <p class="text-center">Your cart is empty.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // PLACE ORDER
  document.getElementById("placeOrderBtn")?.addEventListener("click", async () => {
    const addressIndex = document.querySelector('input[name="selectedAddress"]:checked')?.value;
    if (addressIndex === undefined) {
      return Swal.fire({ icon: 'warning', title: 'No Address Selected', text: 'Please select an address.' });
    }

    try {
      const res = await fetch("/checkout/place-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addressIndex })
      });
      const data = await res.json();
      if (data.success) {
        window.location.href = data.redirect;
      } else {
        Swal.fire({ icon: 'error', title: 'Order Failed', text: data.message || 'Something went wrong.' });
      }
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Server Error', text: 'Unable to place order.' });
    }
  });

  // SHOW/HIDE NEW ADDRESS MODAL
  const addNewAddressBtn = document.getElementById("addNewAddressBtn");
  const newAddressModal = document.getElementById("newAddressModal");
  const closeAddressModal = document.getElementById("closeAddressModal");

  addNewAddressBtn.addEventListener("click", () => {
    newAddressModal.style.display = "block";
  });

  closeAddressModal.addEventListener("click", () => {
    newAddressModal.style.display = "none";
  });

  document.getElementById("newAddressForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());
    formData.isDefault = formData.isDefault === "on";

    try {
      const res = await fetch("/user/address/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const data = await res.json();
      if(data.success){
        Swal.fire({ icon: 'success', title: 'Success', text: data.message }).then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire({ icon: 'error', title: 'Error', text: data.message });
      }
    } catch(err){
      Swal.fire({ icon: 'error', title: 'Error', text: 'Server error' });
    }
  });
</script>

  <%- include("../partials/user/footer") %>
