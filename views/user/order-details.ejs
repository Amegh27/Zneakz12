<%- include("../partials/user/header2") %>

<style>
  #btnn {
    margin-bottom: 15px;
  }
  .order-item {
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  .cancel-btn {
    margin-left: 10px;
  }
  .summary-box {
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #fff;
    padding: 15px;
    margin-top: 15px;
  }
</style>

<head>
  <meta charset="UTF-8">
  <title>Order Details - ZNEAKZ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light py-4">
<div class="container">
  <h2 class="mb-4 text-center fw-bold">Order Details</h2>

  <div class="card p-4 mb-4">
    <p><strong>Order ID:</strong> <%= order.orderID %></p>
    <p class="mb-1 text-muted">Date: <%= new Date(order.createdAt).toLocaleDateString() %></p>
    <p class="mb-1 text-muted">Payment: <%= order.paymentMethod %></p>
    <p><strong>Status:</strong> <%= order.status %></p>

    <!-- Product List -->
    <h5 class="mt-3">Products:</h5>
    <ul class="list-unstyled">
      <% order.items.forEach(item => { %>
        <li class="d-flex align-items-center mb-2 order-item">
          <img src="/uploads/products/<%= item.product.productImage[0] %>"
               alt="<%= item.product.productName %>"
               style="width: 60px; height: 60px; object-fit: cover; margin-right: 10px; border-radius: 5px;">
          <div class="flex-grow-1">
            <strong><%= item.product.productName %></strong><br>
            Size: <%= item.size %>, Qty: <%= item.quantity %>, Price: ₹<%= item.price %>
          </div>
          <% if(order.status === "Placed") { %>
            <form action="/orders/<%= order._id %>/item-cancel/<%= item._id %>" method="POST" class="d-inline">
              <button type="submit" class="btn btn-sm btn-outline-danger cancel-btn">Cancel Item</button>
            </form>
          <% } %>
        </li>
      <% }) %>
    </ul>

    <!-- Shipping Info -->
    <h5 class="mt-3">Shipping Address:</h5>
    <p><%= order.address.name %>, <%= order.address.city %>, <%= order.address.state %>, <%= order.address.pincode %></p>

    <!-- Delivery Information -->
    <h5 class="mt-4">Delivery Information:</h5>
    <ul class="list-group mb-3">
      <li class="list-group-item">
        <strong>Current Status:</strong> <%= order.status %>
      </li>
      <li class="list-group-item">
        <strong>Expected Delivery:</strong>
        <%= order.status === "Delivered"
            ? "Delivered"
            : new Date(order.createdAt.getTime() + 5*24*60*60*1000).toLocaleDateString() %>
      </li>
      <li class="list-group-item">
        <strong>Shipped From:</strong> ZNEAKZ Warehouse, Kochi
      </li>
    </ul>

    <!-- Order Summary -->
    <div class="summary-box mt-4">
      <h5 class="fw-bold mb-3">Order Summary</h5>
      <% 
        let subtotal = 0;
        order.items.forEach(i => subtotal += i.price * i.quantity);
        let tax = subtotal * 0.05;
        let shipping = 50;
        let total = subtotal + tax + shipping;
      %>
      <p>Subtotal: ₹<%= subtotal.toFixed(2) %></p>
      <p>Tax (5%): ₹<%= tax.toFixed(2) %></p>
      <p>Shipping: ₹<%= shipping.toFixed(2) %></p>
      <hr>
      <h5>Total: ₹<%= total.toFixed(2) %></h5>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 d-flex flex-wrap gap-2">
      <% if(order.status === "Placed") { %>
        <form action="/orders/<%= order._id %>/cancel" method="POST" class="me-2">
          <button type="submit" class="btn btn-danger">Cancel Entire Order</button>
        </form>
      <% } %>

      <!-- Download Invoice -->
 <a href="/orders/<%= order._id %>/invoice" class="btn btn-outline-success">
  Download Invoice
</a>


    </div>
  </div>

  <a href="/orders" id="btnn" class="btn btn-outline-dark">Back to Orders</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<%- include("../partials/user/footer") %>

