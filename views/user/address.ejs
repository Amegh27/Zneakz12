<%- include("../partials/user/header2") %>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
.profile-sidebar {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  min-height: 300px;
  border: 1px solid #eee;
}
.profile-sidebar .user-box {
  background: #111;
  color: #fff;
  padding: 22px;
  text-align: left;
}
.profile-sidebar .user-box img {
  width: 56px;
  height: 56px;
  object-fit: cover;
  border-radius: 50%;
  margin-right: 12px;
}
.profile-sidebar .list-group-item {
  border: none;
  padding: 14px 20px;
}
.profile-main {
  background: #f8f6f6;
  border-radius: 12px;
  padding: 36px;
  min-height: 400px;
}
.section-card {
  background: white;
  border-radius: 12px;
  padding: 28px;
  border: 1px solid #eee;
}
.small-muted {
  color: #6c757d;
  font-size: 0.9rem;
}
</style>

<div class="container my-5">
  <div class="row g-4">

    <!-- SIDEBAR -->
    <div class="col-lg-3">
      <div class="profile-sidebar shadow-sm">
        <div class="user-box d-flex align-items-center">
          <div class="profile-avatar">
            <img id="sidebarAvatar" src="<%= user.avatar || '/images/user-avatar.png' %>" alt="" class="rounded-circle" style="width: 56px; height: 56px; object-fit: cover;">
          </div>
          <div>
            <div class="small-muted">Hello</div>
            <div class="fw-bold" style="font-size:1.05rem;"><%= user.name || 'User' %></div>
          </div>
        </div>
        <div class="list-group">
          <a href="/profile" class="list-group-item list-group-item-action" data-tab="profile">Profile</a>
          <a href="#" class="list-group-item list-group-item-action" data-tab="wallet">Wallet</a>
          <a href="/address" class="list-group-item list-group-item-action active" data-tab="address">Address</a>
          <a href="/orders" class="list-group-item list-group-item-action">Orders</a>
          <a href="/logout" id="logout-link" class="list-group-item list-group-item-action">Logout</a>

        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="col-lg-9">
      <div class="profile-main">
        <div id="tab-address" class="section-card">
          <h4 class="text-center fw-bold mb-4">Your Address</h4>

          <% let addr = addresses && addresses.length > 0 ? addresses[0] : {}; %>

          <form id="addressForm" class="row g-3">
            <div class="col-md-12">
              <label class="form-label small-muted">Address</label>
              <input type="text" class="form-control" name="name" value="<%= addr.name || '' %>" required>
            </div>

            <div class="col-md-12">
              <label class="form-label small-muted">City</label>
              <input type="text" class="form-control" name="city" value="<%= addr.city || '' %>" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">State</label>
              <input type="text" class="form-control" name="state" value="<%= addr.state || '' %>" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small-muted">Pincode</label>
              <input type="text" class="form-control" name="pincode" value="<%= addr.pincode || '' %>" required>
            </div>

            <div class="col-12 text-end mt-3">
              <button type="submit" class="btn btn-dark">
                <%= addr && addr.name ? 'Update Address' : 'Save Address' %>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.getElementById('addressForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());

    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    try {
      const res = await fetch('/address', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await res.json();
      if (data.success) {
        Swal.fire('Success', data.message, 'success').then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire('Error', data.message, 'error');
      }
    } catch (err) {
      Swal.fire('Error', 'Server error', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '<%= addr && addr.name ? "Update Address" : "Save Address" %>';
    }
  });

  document.getElementById("logout-link").addEventListener("click", function(event) {
  event.preventDefault(); 

  Swal.fire({
    title: 'Are you sure?',
    text: "You will be logged out.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, logout',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = "/logout"; 
    }
  });
});
</script>

<%- include("../partials/user/footer") %>
